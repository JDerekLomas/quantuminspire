#!/usr/bin/env python3
"""Analyze Kim 2023 kicked Ising results from Tuna-9 hardware."""
import json
import math
import numpy as np
from datetime import datetime

N_QUBITS = 9

# Raw results from Tuna-9 hardware
raw_results = {
    "d1_f1": {"job_id": 416980, "n_steps": 1, "fold": 1, "counts": {"000000000": 3250, "000000001": 78, "000000010": 40, "000000011": 1, "000000100": 42, "000000101": 1, "000001000": 75, "000001001": 3, "000001010": 6, "000010000": 81, "000010001": 2, "000010010": 28, "000010011": 1, "000010100": 1, "000011000": 2, "000011010": 3, "000100000": 50, "000100100": 2, "000101000": 1, "000110000": 3, "001000000": 93, "001000001": 1, "001000010": 3, "001000011": 1, "001000100": 1, "001001000": 26, "001001001": 1, "001001010": 1, "001010000": 5, "001010010": 1, "001100000": 1, "001101000": 1, "001110000": 1, "010000000": 120, "010000001": 4, "010000010": 2, "010000100": 1, "010001000": 1, "010010000": 10, "010010010": 2, "010100000": 2, "011000000": 7, "011001000": 2, "100000000": 108, "100000001": 3, "100000010": 4, "100000100": 1, "100001000": 4, "100010000": 3, "100011000": 1, "100100000": 1, "101000000": 5, "101001000": 2, "101010000": 1, "110000000": 4, "111000000": 2}},
    "d3_f1": {"job_id": 416981, "n_steps": 3, "fold": 1, "counts": {"000000000": 1738, "000000001": 34, "000000010": 81, "000000011": 5, "000000100": 52, "000000101": 2, "000000110": 2, "000001000": 60, "000001001": 2, "000001010": 4, "000001100": 1, "000010000": 93, "000010010": 39, "000010011": 2, "000010100": 4, "000011000": 4, "000011010": 2, "000100000": 92, "000100001": 1, "000100010": 2, "000100100": 4, "000101000": 2, "000110000": 3, "000110010": 3, "001000000": 249, "001000001": 4, "001000010": 6, "001000100": 7, "001001000": 40, "001001001": 1, "001001010": 5, "001010000": 46, "001010010": 12, "001010100": 1, "001010110": 1, "001011000": 3, "001011001": 1, "001011010": 4, "001100000": 11, "001100010": 1, "001100100": 1, "001101000": 2, "001110000": 3, "001111000": 1, "010000000": 240, "010000001": 3, "010000010": 6, "010000100": 6, "010000101": 2, "010001000": 10, "010001010": 2, "010001100": 1, "010010000": 21, "010010010": 7, "010010011": 1, "010010110": 1, "010011000": 1, "010100000": 11, "010101000": 2, "010110000": 1, "010110100": 1, "011000000": 43, "011000001": 2, "011000010": 3, "011000011": 1, "011000100": 2, "011001000": 9, "011001010": 2, "011010000": 12, "011010010": 3, "011010100": 3, "011011000": 1, "011100000": 2, "100000000": 304, "100000001": 6, "100000010": 17, "100000011": 1, "100000100": 16, "100001000": 16, "100001010": 3, "100001110": 1, "100010000": 32, "100010010": 12, "100010100": 2, "100011000": 7, "100011010": 1, "100100000": 21, "100100001": 1, "100100010": 1, "100100100": 3, "100101000": 1, "100110000": 3, "100110010": 3, "100111000": 1, "101000000": 115, "101000001": 2, "101000010": 4, "101000100": 2, "101001000": 14, "101001010": 1, "101010000": 21, "101010001": 1, "101010010": 2, "101010100": 1, "101010110": 1, "101011000": 3, "101011010": 1, "101100000": 11, "101100100": 1, "101101000": 1, "101110000": 2, "101110100": 1, "110000000": 273, "110000001": 9, "110000010": 7, "110000011": 1, "110000100": 7, "110000101": 1, "110000110": 1, "110001000": 12, "110001010": 1, "110010000": 18, "110010010": 5, "110011000": 2, "110100000": 16, "110100010": 1, "111000000": 51, "111000001": 1, "111000010": 1, "111000110": 1, "111001000": 9, "111010000": 7, "111010010": 4, "111100000": 2}},
    "d5_f1": {"job_id": 416982, "n_steps": 5, "fold": 1, "counts": {"000000000": 569, "000000001": 18, "000000010": 45, "000000100": 34, "000000110": 4, "000001000": 36, "000001010": 6, "000001100": 2, "000001110": 1, "000010000": 65, "000010001": 1, "000010010": 27, "000010100": 8, "000010110": 2, "000011000": 9, "000011010": 3, "000011011": 1, "000011110": 2, "000100000": 31, "000100010": 3, "000100100": 2, "000101000": 5, "000110000": 5, "000110010": 1, "000110100": 2, "000111100": 1, "001000000": 245, "001000001": 7, "001000010": 20, "001000100": 14, "001000101": 2, "001000110": 2, "001001000": 28, "001001001": 1, "001001010": 8, "001001100": 1, "001010000": 56, "001010001": 2, "001010010": 14, "001010100": 3, "001011000": 11, "001011010": 4, "001011100": 1, "001011110": 1, "001100000": 27, "001100010": 1, "001100100": 3, "001101000": 2, "001101001": 1, "001110000": 8, "001110100": 1, "001111000": 1, "010000000": 228, "010000001": 10, "010000010": 12, "010000100": 13, "010000101": 1, "010000110": 2, "010001000": 29, "010001001": 1, "010001010": 2, "010001100": 1, "010010000": 40, "010010010": 16, "010010100": 4, "010011000": 9, "010011010": 4, "010100000": 18, "010100011": 1, "010100100": 1, "010110000": 5, "010110010": 1, "010110110": 1, "010111000": 1, "011000000": 209, "011000001": 4, "011000010": 16, "011000100": 12, "011000110": 1, "011001000": 20, "011001010": 1, "011001100": 1, "011001110": 1, "011010000": 36, "011010010": 12, "011010100": 3, "011010110": 2, "011011000": 3, "011011010": 2, "011100000": 17, "011100010": 1, "011101000": 1, "011101100": 1, "011110000": 5, "011110010": 2, "011111000": 1, "011111010": 1, "100000000": 369, "100000001": 4, "100000010": 22, "100000100": 23, "100000110": 5, "100001000": 28, "100001001": 2, "100001010": 4, "100001100": 3, "100001110": 2, "100010000": 64, "100010001": 1, "100010010": 21, "100010100": 6, "100010110": 1, "100011000": 10, "100011001": 2, "100011010": 4, "100011100": 1, "100100000": 22, "100100010": 1, "100100100": 3, "100100110": 1, "100101000": 4, "100110000": 3, "100110010": 1, "100110100": 3, "100111100": 2, "101000000": 259, "101000001": 7, "101000010": 18, "101000011": 1, "101000100": 16, "101000111": 1, "101001000": 20, "101001001": 3, "101001010": 4, "101001011": 1, "101010000": 45, "101010001": 2, "101010010": 17, "101010011": 1, "101010100": 3, "101011000": 11, "101011001": 1, "101011010": 1, "101011100": 1, "101100000": 18, "101100001": 2, "101100010": 1, "101101000": 3, "101101100": 1, "101110000": 3, "101110010": 1, "101110100": 1, "101111000": 1, "101111010": 1, "110000000": 266, "110000001": 2, "110000010": 24, "110000011": 2, "110000100": 19, "110000110": 3, "110001000": 31, "110001010": 4, "110001100": 2, "110001101": 1, "110010000": 43, "110010001": 1, "110010010": 7, "110010100": 5, "110011000": 7, "110011001": 1, "110011010": 2, "110100000": 23, "110100001": 1, "110100010": 2, "110100011": 1, "110100100": 2, "110101000": 3, "110101010": 1, "110110000": 7, "110110100": 2, "110111000": 2, "111000000": 315, "111000001": 5, "111000010": 18, "111000100": 12, "111000101": 1, "111001000": 23, "111001010": 3, "111001011": 1, "111001100": 1, "111010000": 36, "111010001": 1, "111010010": 7, "111010011": 2, "111010100": 4, "111011000": 5, "111011001": 1, "111011010": 2, "111011011": 1, "111011100": 1, "111100000": 20, "111100001": 2, "111100010": 3, "111100100": 3, "111101000": 3, "111110000": 6, "111111010": 1}},
    "d1_f3": {"job_id": 416983, "n_steps": 1, "fold": 3, "counts": {"000000000": 2308, "000000001": 39, "000000010": 83, "000000011": 4, "000000100": 23, "000000110": 1, "000001000": 58, "000001001": 3, "000001010": 9, "000001100": 2, "000001110": 1, "000010000": 181, "000010001": 2, "000010010": 20, "000010100": 5, "000010110": 2, "000011000": 5, "000011010": 4, "000100000": 61, "000100001": 1, "000100100": 10, "000100111": 1, "000101000": 2, "000101100": 1, "000110000": 8, "001000000": 189, "001000001": 2, "001000010": 13, "001000100": 5, "001000101": 1, "001000110": 1, "001001000": 11, "001001001": 1, "001001010": 2, "001010000": 23, "001010001": 1, "001010010": 2, "001010100": 1, "001011000": 2, "001011010": 1, "001100000": 5, "001100100": 2, "001110010": 1, "010000000": 428, "010000001": 8, "010000010": 16, "010000100": 5, "010000110": 1, "010001000": 12, "010001001": 1, "010001010": 1, "010001100": 1, "010010000": 29, "010010001": 1, "010010010": 2, "010010100": 1, "010011000": 1, "010011001": 2, "010011010": 1, "010100000": 10, "010100010": 1, "010110000": 2, "011000000": 36, "011000010": 1, "011000100": 1, "011001000": 1, "011010000": 4, "011010100": 1, "011010110": 2, "011100000": 6, "100000000": 229, "100000001": 8, "100000010": 8, "100000100": 5, "100001000": 8, "100010000": 26, "100010001": 1, "100010010": 5, "100010100": 1, "100010101": 1, "100100000": 4, "100100100": 1, "100110010": 2, "101000000": 32, "101000001": 1, "101000010": 1, "101001000": 3, "101010000": 6, "101010001": 1, "101010010": 1, "101010100": 1, "101100000": 3, "110000000": 53, "110000001": 1, "110000010": 3, "110001000": 2, "110010000": 3, "110010001": 1, "110010010": 1, "110100000": 3, "110100100": 1, "111000000": 5, "111001000": 1, "111010000": 1, "111101001": 1}},
    "d3_f3": {"job_id": 416984, "n_steps": 3, "fold": 3, "counts": {"000000000": 767, "000000001": 17, "000000010": 86, "000000011": 4, "000000100": 26, "000000101": 1, "000000110": 3, "000001000": 32, "000001001": 1, "000001010": 6, "000001100": 1, "000001110": 1, "000010000": 229, "000010001": 4, "000010010": 36, "000010011": 1, "000010100": 8, "000010101": 1, "000010110": 4, "000011000": 13, "000011010": 3, "000011100": 1, "000100000": 155, "000100001": 6, "000100010": 21, "000100100": 7, "000100101": 2, "000100110": 1, "000101000": 12, "000101010": 1, "000110000": 47, "000110001": 1, "000110010": 9, "000110100": 2, "000110110": 1, "000111000": 1, "001000000": 324, "001000001": 2, "001000010": 39, "001000011": 2, "001000100": 13, "001000110": 1, "001001000": 14, "001001001": 1, "001001010": 6, "001010000": 102, "001010001": 3, "001010010": 28, "001010100": 7, "001011000": 8, "001011001": 1, "001011010": 2, "001100000": 59, "001100001": 2, "001100010": 11, "001100100": 3, "001100110": 1, "001101000": 1, "001101110": 1, "001110000": 21, "001110001": 1, "001110010": 3, "001110100": 1, "001110110": 1, "001111000": 2, "010000000": 145, "010000001": 5, "010000010": 17, "010000011": 1, "010000100": 4, "010001000": 10, "010001110": 1, "010010000": 38, "010010001": 2, "010010010": 6, "010010100": 3, "010011000": 2, "010011100": 1, "010100000": 38, "010100010": 5, "010100100": 1, "010101000": 2, "010101100": 1, "010110000": 11, "010110001": 1, "010110010": 4, "010110100": 1, "010111010": 2, "011000000": 74, "011000010": 9, "011000011": 1, "011000100": 3, "011001000": 4, "011001010": 3, "011010000": 20, "011010001": 1, "011010010": 6, "011010100": 1, "011010110": 1, "011011000": 2, "011011001": 1, "011011100": 1, "011100000": 15, "011100010": 4, "011100100": 2, "011100110": 1, "011101000": 1, "011110000": 8, "011110001": 1, "011110010": 2, "011110100": 1, "100000000": 274, "100000001": 6, "100000010": 33, "100000100": 10, "100000101": 1, "100000110": 3, "100001000": 19, "100001010": 3, "100001100": 3, "100010000": 112, "100010001": 2, "100010010": 15, "100010011": 1, "100010100": 11, "100011000": 3, "100011010": 2, "100100000": 72, "100100001": 3, "100100010": 13, "100100011": 1, "100100100": 9, "100100110": 4, "100101000": 3, "100110000": 16, "100110010": 6, "100110100": 4, "100110110": 2, "100111000": 6, "101000000": 172, "101000001": 2, "101000010": 23, "101000100": 5, "101000101": 2, "101000110": 1, "101001000": 9, "101001001": 1, "101001010": 1, "101001100": 1, "101010000": 67, "101010001": 1, "101010010": 11, "101010100": 7, "101011000": 3, "101100000": 31, "101100001": 1, "101100010": 6, "101100011": 2, "101100100": 1, "101100110": 1, "101110000": 11, "101110001": 1, "101110010": 2, "101110011": 1, "101110100": 1, "101111000": 2, "110000000": 130, "110000010": 20, "110000100": 4, "110000110": 1, "110001000": 9, "110001010": 2, "110010000": 52, "110010001": 1, "110010010": 8, "110010100": 4, "110010110": 1, "110011000": 1, "110011010": 1, "110011011": 1, "110100000": 43, "110100010": 4, "110100011": 1, "110100100": 1, "110100110": 2, "110110000": 19, "110110001": 1, "110110010": 6, "110111000": 2, "111000000": 60, "111000001": 1, "111000010": 9, "111000100": 2, "111001000": 3, "111010000": 24, "111010010": 6, "111010100": 2, "111010110": 2, "111011000": 3, "111011100": 1, "111100000": 15, "111100001": 1, "111100010": 2, "111101000": 3, "111110000": 7, "111110001": 1, "111110010": 2, "111111100": 1}},
}


def compute_mz(counts, n_qubits=N_QUBITS):
    """Compute M_z = (1/N) sum_q <Z_q> from measurement counts."""
    total = sum(counts.values())
    if total == 0:
        return 0.0, [0.0] * n_qubits

    z_per_qubit = [0.0] * n_qubits
    for bitstring, count in counts.items():
        for q in range(n_qubits):
            bit = int(bitstring[-(q + 1)])  # MSB-first extraction
            z_per_qubit[q] += (1 - 2 * bit) * count  # 0->+1, 1->-1

    z_expectations = [z / total for z in z_per_qubit]
    mz = sum(z_expectations) / n_qubits
    return mz, z_expectations


def richardson_extrapolation(points):
    """Richardson extrapolation from (fold_factor, value) points to fold=0."""
    # Linear: use fold=1 and fold=3
    if len(points) >= 2:
        f1, v1 = points[0]
        f3, v3 = points[1]
        # Linear extrapolation to fold=0
        linear = v1 - f1 * (v3 - v1) / (f3 - f1)
    else:
        linear = points[0][1]
    return linear


# Compute M_z for each experiment
print("=" * 70)
print("Kim 2023 Kicked Ising on Tuna-9 Hardware")
print("Clifford checkpoint (theta_h=0): ideal M_z = 1.0")
print("=" * 70)

results = {}
for name, data in raw_results.items():
    mz, z_exp = compute_mz(data["counts"])
    results[name] = {
        "mz": mz,
        "z_expectations": z_exp,
        "n_steps": data["n_steps"],
        "fold": data["fold"],
        "job_id": data["job_id"],
    }
    print(f"\n{name} (d={data['n_steps']}, fold={data['fold']}, {data['job_id']}):")
    print(f"  M_z = {mz:.6f}  (error = {abs(1.0 - mz):.6f})")
    print(f"  Per-qubit Z: {[f'{z:.4f}' for z in z_exp]}")

# ZNE: Richardson extrapolation using fold=1 and fold=3 pairs
print(f"\n{'=' * 70}")
print("ZNE: Richardson Extrapolation (fold=1,3 -> fold=0)")
print(f"{'=' * 70}")

zne_results = {}
# d=1: use d1_f1 and d1_f3
for depth in [1, 3]:
    f1_name = f"d{depth}_f1"
    f3_name = f"d{depth}_f3"
    if f1_name in results and f3_name in results:
        f1_mz = results[f1_name]["mz"]
        f3_mz = results[f3_name]["mz"]
        zne_mz = richardson_extrapolation([(1, f1_mz), (3, f3_mz)])
        zne_error = abs(1.0 - zne_mz)
        noisy_error = abs(1.0 - f1_mz)
        improvement = noisy_error / zne_error if zne_error > 0 else float("inf")
        zne_results[depth] = {
            "noisy_mz": f1_mz,
            "zne_mz": zne_mz,
            "zne_error": zne_error,
            "noisy_error": noisy_error,
            "improvement": improvement,
        }
        print(f"\n  d={depth}:")
        print(f"    Noisy (f=1):  M_z = {f1_mz:.6f}  (error = {noisy_error:.6f})")
        print(f"    Folded (f=3): M_z = {f3_mz:.6f}")
        print(f"    ZNE:          M_z = {zne_mz:.6f}  (error = {zne_error:.6f})")
        print(f"    Improvement:  {improvement:.1f}x")

# Summary table
print(f"\n{'=' * 70}")
print("SUMMARY TABLE")
print(f"{'=' * 70}")
print(f"{'Circuit':<12} {'Steps':>5} {'Fold':>4} {'CZ':>5} {'M_z':>8} {'Error':>8} {'|000..0>%':>10}")

for name in ["d1_f1", "d3_f1", "d5_f1", "d1_f3", "d3_f3"]:
    data = raw_results[name]
    r = results[name]
    cz_per_step = 20  # 2 CZ per edge * 10 edges
    cz = data["n_steps"] * data["fold"] * cz_per_step
    all_zero = data["counts"].get("000000000", 0) / 4096 * 100
    print(f"{name:<12} {data['n_steps']:>5} {data['fold']:>4} {cz:>5} {r['mz']:>8.4f} {abs(1-r['mz']):>8.5f} {all_zero:>9.1f}%")

print(f"\n{'Circuit':<12} {'Noisy':>8} {'ZNE':>8} {'Improvement':>12}")
print("-" * 44)
for depth, zr in zne_results.items():
    print(f"d={depth:<10} {zr['noisy_mz']:>8.4f} {zr['zne_mz']:>8.4f} {zr['improvement']:>11.1f}x")

# Compare with emulator simulation (from replicate_kim.py)
print(f"\n{'=' * 70}")
print("COMPARISON: Tuna-9 vs Emulator Simulation")
print(f"{'=' * 70}")
emulator_noisy = {1: 0.9721, 3: 0.9188, 5: 0.8684}
emulator_zne = {1: 1.0000, 3: 0.9990, 5: 0.9953}
print(f"{'Depth':>5} {'Tuna9 Raw':>10} {'Emu Noisy':>10} {'Tuna9 ZNE':>10} {'Emu ZNE':>10}")
for d in [1, 3, 5]:
    t9_raw = results[f"d{d}_f1"]["mz"]
    emu_n = emulator_noisy.get(d, "n/a")
    t9_zne = zne_results[d]["zne_mz"] if d in zne_results else "n/a"
    emu_z = emulator_zne.get(d, "n/a")
    t9_zne_str = f"{t9_zne:.4f}" if isinstance(t9_zne, float) else t9_zne
    print(f"{d:>5} {t9_raw:>10.4f} {emu_n:>10.4f} {t9_zne_str:>10} {emu_z:>10.4f}")

# Save results
output = {
    "schema_version": "1.0",
    "experiment_id": "kim2023-ising-tuna9-hardware",
    "paper": {
        "title": "Evidence for the utility of quantum computing before fault tolerance",
        "authors": "Kim et al.",
        "arxiv": "2302.11590",
        "journal": "Nature 618, 500-505 (2023)",
    },
    "backend": "tuna9",
    "n_qubits": N_QUBITS,
    "n_edges": 10,
    "topology": "tuna9",
    "theta_h": 0.0,
    "theta_j": -math.pi / 4,
    "shots": 4096,
    "timestamp": datetime.now().isoformat(),
    "note": "9-qubit kicked Ising on Tuna-9 hardware. Original paper used 127 qubits on IBM Eagle with PEA. We use 9 qubits with basic ZNE gate folding.",
    "raw_results": {
        name: {
            "n_steps": data["n_steps"],
            "fold_factor": data["fold"],
            "job_id": data["job_id"],
            "mz": results[name]["mz"],
            "z_expectations": results[name]["z_expectations"],
            "all_zero_fraction": data["counts"].get("000000000", 0) / 4096,
        }
        for name, data in raw_results.items()
    },
    "depth_sweep": {
        "description": "M_z vs Trotter depth at theta_h=0 (Clifford, ideal M_z=1.0)",
        "results": [
            {
                "trotter_steps": d,
                "ideal_mz": 1.0,
                "noisy_mz": results[f"d{d}_f1"]["mz"],
                "noisy_error": abs(1.0 - results[f"d{d}_f1"]["mz"]),
            }
            for d in [1, 3, 5]
        ],
    },
    "zne": {
        "description": "ZNE via gate folding (fold=1,3) with linear Richardson extrapolation",
        "results": [
            {
                "trotter_steps": d,
                "noisy_mz": zne_results[d]["noisy_mz"],
                "folded_mz": results[f"d{d}_f3"]["mz"],
                "zne_mz": zne_results[d]["zne_mz"],
                "zne_error": zne_results[d]["zne_error"],
                "improvement_factor": zne_results[d]["improvement"],
            }
            for d in sorted(zne_results.keys())
        ],
    },
    "summary": {
        "noisy_mae": np.mean([abs(1.0 - results[f"d{d}_f1"]["mz"]) for d in [1, 3, 5]]),
        "zne_mae": np.mean([zne_results[d]["zne_error"] for d in zne_results]),
        "zne_improvement_factor": np.mean([zne_results[d]["improvement"] for d in zne_results]),
        "worst_qubit": int(np.argmin([results["d1_f1"]["z_expectations"][q] for q in range(N_QUBITS)])),
        "best_qubit": int(np.argmax([results["d1_f1"]["z_expectations"][q] for q in range(N_QUBITS)])),
    },
}

outfile = "experiments/results/kim2023-ising-tuna9-hardware.json"
with open(outfile, "w") as f:
    json.dump(output, f, indent=2, default=str)
print(f"\nSaved: {outfile}")
