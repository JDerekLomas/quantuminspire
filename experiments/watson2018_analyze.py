#!/usr/bin/env python3
"""
Analyze Watson 2018 replication results from Tuna-9 hardware.
Raw counts embedded from MCP qi_get_results (jobs 425359-425378).
"""
import json

QUBIT_A = 4   # logical qubit 0 → physical q4
QUBIT_B = 6   # logical qubit 1 → physical q6
N_QUBITS = 9
SHOTS = 4096

print("=" * 72)
print("  Watson et al. 2018 — Tuna-9 Hardware Results Analysis")
print(f"  Qubit pair: q[{QUBIT_A}]-q[{QUBIT_B}], {SHOTS} shots per circuit")
print("=" * 72)

# =============================================================================
# Raw hardware counts (embedded from MCP qi_get_results)
# =============================================================================
RAW = {
    "bell_PhiPlus_ZZ": {"000000000": 1824, "000000001": 21, "000000010": 6, "000000011": 1, "000000100": 19, "000000101": 1, "000001000": 7, "000010000": 244, "000010001": 2, "000010100": 1, "000011000": 2, "000100000": 27, "000101000": 1, "000110000": 4, "001000000": 184, "001000001": 4, "001000100": 4, "001001000": 1, "001010000": 1632, "001010001": 22, "001010010": 7, "001010100": 14, "001011000": 10, "001011001": 1, "001100000": 2, "001110000": 26, "001110001": 1, "010000000": 8, "011010000": 4, "100000000": 9, "100100000": 1, "101000000": 2, "101010000": 4},
    "bell_PhiMinus_ZZ": {"000000000": 1776, "000000001": 41, "000000010": 3, "000000011": 1, "000000100": 17, "000001000": 11, "000010000": 232, "000010001": 6, "000010010": 3, "000010100": 3, "000011000": 1, "000100000": 19, "000100001": 1, "000110000": 5, "001000000": 177, "001000001": 2, "001000100": 1, "001001000": 3, "001010000": 1692, "001010001": 24, "001010010": 4, "001010100": 16, "001011000": 8, "001100000": 2, "001110000": 17, "001110001": 1, "010000000": 9, "011000000": 2, "011010000": 8, "100000000": 5, "100010000": 1, "101000000": 1, "101010000": 4},
    "bell_PsiPlus_ZZ": {"000000000": 151, "000000001": 3, "000000100": 2, "000001000": 1, "000010000": 1636, "000010001": 34, "000010010": 3, "000010100": 10, "000010101": 1, "000011000": 10, "000110000": 23, "001000000": 1838, "001000001": 24, "001000010": 9, "001000011": 2, "001000100": 14, "001001000": 12, "001010000": 236, "001010001": 2, "001010100": 3, "001100000": 22, "010000000": 1, "010010000": 21, "011000000": 19, "011010000": 5, "100000000": 1, "100010000": 5, "101000000": 5, "101010000": 3},
    "bell_PsiMinus_ZZ": {"000000000": 148, "000000001": 5, "000000100": 2, "000010000": 1697, "000010001": 24, "000010010": 5, "000010100": 13, "000011000": 7, "000110000": 22, "001000000": 1794, "001000001": 25, "001000010": 2, "001000100": 15, "001001000": 11, "001001100": 1, "001010000": 224, "001010001": 3, "001010010": 1, "001010100": 3, "001100000": 19, "001110000": 5, "010000000": 1, "010010000": 21, "010010001": 2, "011000000": 20, "011000001": 2, "011001000": 1, "011010000": 7, "100000000": 1, "100010000": 7, "101000000": 7, "101000001": 1},
    "bell_PhiPlus_XX": {"000000000": 1880, "000000001": 28, "000000010": 7, "000000100": 9, "000001000": 7, "000010000": 92, "000010001": 4, "000010100": 2, "000011000": 1, "000100000": 22, "000100010": 1, "000101000": 1, "000110000": 1, "001000000": 321, "001000001": 3, "001001000": 1, "001010000": 1598, "001010001": 32, "001010010": 4, "001010011": 1, "001010100": 8, "001010101": 1, "001011000": 2, "001100000": 2, "001110000": 14, "001110001": 1, "010000000": 20, "010010000": 1, "011000000": 2, "011010000": 15, "100000000": 10, "101000000": 1, "101010000": 4},
    "bell_PhiMinus_XX": {"000000000": 230, "000000001": 3, "000000100": 3, "000010000": 1770, "000010001": 31, "000010010": 6, "000010100": 24, "000011000": 12, "000011001": 1, "000100000": 2, "000110000": 22, "000110001": 1, "000110100": 1, "001000000": 1578, "001000001": 26, "001000010": 2, "001000100": 8, "001001000": 8, "001001001": 1, "001010000": 289, "001010001": 2, "001010100": 1, "001100000": 24, "001100100": 1, "001110000": 1, "010000000": 1, "010010000": 15, "010010001": 1, "011000000": 19, "011000100": 1, "011010000": 1, "100010000": 5, "101000000": 4, "101010000": 1, "111000000": 1},
    "bell_PsiPlus_XX": {"000000000": 1842, "000000001": 38, "000000010": 4, "000000100": 10, "000001000": 11, "000010000": 119, "000010001": 4, "000010100": 1, "000100000": 21, "000100100": 1, "000110000": 1, "001000000": 267, "001000001": 3, "001000100": 5, "001001000": 4, "001010000": 1610, "001010001": 26, "001010010": 4, "001010100": 15, "001011000": 10, "001011100": 1, "001100000": 4, "001110000": 18, "010000000": 24, "010000100": 1, "010010000": 3, "010100000": 1, "011000000": 9, "011010000": 28, "100000000": 2, "100001000": 1, "101000000": 2, "101010000": 6},
    "bell_PsiMinus_XX": {"000000000": 111, "000000001": 2, "000000100": 1, "000001000": 1, "000010000": 1796, "000010001": 25, "000010010": 4, "000010011": 1, "000010100": 11, "000010101": 1, "000011000": 11, "000100000": 2, "000100001": 1, "000110000": 23, "000110001": 1, "000110100": 2, "001000000": 1681, "001000001": 34, "001000010": 4, "001000011": 1, "001000100": 11, "001001000": 10, "001001100": 1, "001010000": 247, "001010001": 2, "001010010": 2, "001010100": 1, "001011000": 2, "001100000": 29, "001101000": 1, "001110000": 2, "010000000": 2, "010010000": 31, "011000000": 29, "011001000": 1, "011010000": 4, "100000000": 1, "100010000": 2, "101000000": 4, "101010000": 1},
    "bell_PhiPlus_YY": {"000000000": 262, "000000001": 3, "000000100": 2, "000001000": 5, "000010000": 1304, "000010001": 14, "000010010": 4, "000010100": 10, "000010101": 1, "000011000": 10, "000100000": 4, "000110000": 8, "001000000": 2096, "001000001": 32, "001000010": 8, "001000100": 16, "001000101": 1, "001001000": 4, "001010000": 228, "001010001": 4, "001010010": 1, "001010100": 3, "001100000": 21, "001110000": 5, "001110001": 1, "010000000": 1, "010000100": 1, "010010000": 13, "011000000": 12, "011000100": 1, "011010000": 2, "011100000": 1, "100000000": 3, "100010000": 5, "101000000": 7, "101010000": 3},
    "bell_PhiMinus_YY": {"000000000": 1341, "000000001": 16, "000000010": 1, "000000100": 7, "000000101": 1, "000001000": 12, "000010000": 252, "000010001": 5, "000010010": 1, "000010100": 1, "000010101": 1, "000100000": 17, "000100001": 1, "000110000": 9, "001000000": 308, "001000001": 4, "001000010": 1, "001000100": 1, "001001000": 3, "001010000": 1945, "001010001": 32, "001010010": 10, "001010100": 10, "001011000": 24, "001011001": 1, "001011010": 1, "001100000": 2, "001100001": 1, "001100100": 1, "001110000": 30, "010000000": 11, "010010000": 1, "011000000": 3, "011010000": 22, "011010010": 1, "100000000": 6, "100010000": 3, "101010000": 8, "101010001": 2},
    "bell_PsiPlus_YY": {"000000000": 2026, "000000001": 39, "000000010": 6, "000000100": 18, "000001000": 11, "000010000": 196, "000010001": 2, "000010010": 2, "000010100": 2, "000011000": 1, "000100000": 23, "000100001": 1, "000100100": 1, "000110000": 2, "001000000": 234, "001000001": 2, "001000010": 1, "001000100": 3, "001001000": 2, "001010000": 1342, "001010001": 23, "001010010": 1, "001010100": 14, "001011000": 4, "001100000": 3, "001110000": 19, "010000000": 47, "010000001": 1, "010000100": 1, "010010000": 6, "010010001": 1, "011000000": 6, "011000001": 1, "011010000": 35, "011011001": 1, "100000000": 8, "100000001": 1, "100010000": 1, "100100000": 1, "101000000": 1, "101010000": 6, "111010000": 1},
    "bell_PsiMinus_YY": {"000000000": 251, "000000001": 5, "000010000": 1915, "000010001": 33, "000010010": 3, "000010100": 14, "000011000": 16, "000100000": 2, "000110000": 27, "000110001": 1, "000110100": 1, "001000000": 1406, "001000001": 28, "001000010": 3, "001000100": 10, "001001000": 9, "001010000": 248, "001010001": 5, "001010010": 1, "001011000": 1, "001100000": 19, "001110000": 5, "010000000": 2, "010010000": 47, "010110000": 1, "011000000": 29, "011000001": 1, "011010000": 6, "011010100": 1, "011011000": 1, "100000000": 1, "100010000": 1, "101000000": 2, "101010000": 1},
    "dj_constant_0": {"000000000": 1830, "000000001": 28, "000000010": 4, "000000100": 20, "000001000": 15, "000001100": 1, "000010000": 15, "000100000": 26, "001000000": 1972, "001000001": 31, "001000010": 4, "001000100": 20, "001001000": 13, "001001001": 1, "001010000": 11, "001100000": 21, "010000000": 27, "010000001": 1, "010001000": 2, "010010000": 1, "010100000": 1, "011000000": 38, "011000001": 1, "011000100": 1, "100000000": 6, "101000000": 5, "111000000": 1},
    "dj_constant_1": {"000000000": 1942, "000000001": 23, "000000010": 5, "000000100": 20, "000001000": 8, "000001001": 1, "000001010": 1, "000010000": 12, "000010001": 1, "000100000": 18, "000100100": 1, "001000000": 1937, "001000001": 26, "001000010": 5, "001000011": 1, "001000100": 18, "001000101": 1, "001001000": 12, "001010000": 4, "001100000": 26, "010000000": 13, "010010000": 1, "010100000": 1, "011000000": 4, "100000000": 4, "101000000": 9, "101000001": 1, "101100000": 1},
    "dj_balanced_id": {"000000000": 235, "000000001": 4, "000000100": 2, "000001000": 1, "000010000": 1674, "000010001": 26, "000010010": 5, "000010100": 15, "000011000": 11, "000100000": 4, "000110000": 19, "001000000": 267, "001000001": 2, "001000100": 2, "001010000": 1702, "001010001": 20, "001010010": 4, "001010100": 11, "001011000": 5, "001100000": 4, "001110000": 20, "010000000": 5, "010010000": 22, "010011000": 1, "011000000": 2, "011010000": 23, "100000000": 1, "100010000": 2, "100110000": 1, "101010000": 6},
    "dj_balanced_not": {"000000000": 224, "000000001": 5, "000001000": 1, "000010000": 1599, "000010001": 34, "000010010": 3, "000010100": 15, "000011000": 11, "000100000": 3, "000110000": 26, "001000000": 257, "001000001": 4, "001001000": 1, "001010000": 1702, "001010001": 25, "001010010": 1, "001010100": 10, "001011000": 8, "001011001": 1, "001011100": 1, "001110000": 14, "001110001": 1, "010000000": 14, "010010000": 51, "010010001": 1, "010010100": 1, "011000000": 6, "011000001": 2, "011010000": 53, "011010100": 1, "011110000": 3, "100010000": 10, "101000000": 2, "101010000": 5, "111010000": 1},
    "grover_target_00": {"000000000": 3337, "000000001": 38, "000000010": 6, "000000100": 25, "000000101": 1, "000001000": 10, "000010000": 77, "000010001": 2, "000010100": 1, "000100000": 47, "000100001": 1, "000100010": 1, "000100100": 1, "000101000": 1, "000110000": 1, "001000000": 248, "001000001": 7, "001000100": 1, "001010000": 60, "001010001": 1, "001100000": 3, "001110000": 1, "010000000": 196, "010000001": 2, "010000100": 2, "010100000": 2, "011000000": 11, "011010000": 3, "100000000": 9, "110000000": 1},
    "grover_target_01": {"000000000": 209, "000000001": 2, "000000010": 1, "000000100": 4, "000001000": 2, "000010000": 47, "000010001": 2, "000010100": 1, "000100000": 3, "001000000": 3432, "001000001": 58, "001000010": 8, "001000100": 31, "001001000": 21, "001010000": 68, "001100000": 48, "010000000": 7, "010010000": 2, "011000000": 127, "011000001": 2, "011000100": 1, "011001000": 3, "011010000": 4, "011110000": 1, "101000000": 10, "101100000": 1, "111000000": 1},
    "grover_target_10": {"000000000": 145, "000000001": 2, "000010000": 3177, "000010001": 67, "000010010": 8, "000010100": 31, "000010101": 2, "000011000": 27, "000100000": 3, "000110000": 38, "000110001": 1, "000111000": 2, "001000000": 82, "001000001": 2, "001000100": 1, "001001000": 1, "001010000": 237, "001010001": 5, "001010010": 1, "001010100": 2, "001011000": 1, "001100000": 1, "001110000": 3, "010000000": 13, "010010000": 208, "010010001": 2, "010010010": 1, "010010100": 5, "010110000": 1, "011000000": 4, "011010000": 9, "100010000": 11, "101010000": 2, "110010001": 1},
    "grover_target_11": {"000000000": 67, "000000001": 1, "000000100": 1, "000001000": 1, "000010000": 210, "000010001": 7, "000010100": 1, "000011000": 1, "000110000": 1, "001000000": 168, "001000001": 2, "001000010": 1, "001000100": 1, "001001100": 1, "001010000": 3319, "001010001": 45, "001010010": 8, "001010100": 30, "001011000": 18, "001011010": 1, "001100000": 2, "001110000": 49, "001110001": 1, "001110100": 1, "001111000": 1, "010000000": 2, "010010000": 10, "011000000": 13, "011000100": 1, "011010000": 117, "011010001": 2, "011011000": 1, "011110000": 3, "101000000": 1, "101010000": 7, "111010000": 1},
}


# =============================================================================
# Helper functions
# =============================================================================
def extract_2q_probs(counts, qa_idx, qb_idx):
    """Extract 2-qubit marginal from 9-qubit counts.
    QI/qxelarator uses MSB-first: bs[0]=q_{n-1}, bs[n-1]=q_0.
    To read qubit j: bs[n-1-j] where n=len(bs).
    """
    probs = {"00": 0, "01": 0, "10": 0, "11": 0}
    total = sum(counts.values())
    for bs, count in counts.items():
        n = len(bs)
        ba = bs[n - 1 - qa_idx]
        bb = bs[n - 1 - qb_idx]
        probs[ba + bb] += count / total
    return probs


def correlator(probs):
    """<AB> = P(00) + P(11) - P(01) - P(10)"""
    return probs["00"] + probs["11"] - probs["01"] - probs["10"]


# =============================================================================
# Bell State Tomography Analysis
# =============================================================================
print("\n--- Bell State Tomography ---")

bell_states = ["PhiPlus", "PhiMinus", "PsiPlus", "PsiMinus"]
bases = ["ZZ", "XX", "YY"]
bell_results = {}

for state in bell_states:
    corrs = {}
    probs_all = {}
    for basis in bases:
        key = f"bell_{state}_{basis}"
        probs = extract_2q_probs(RAW[key], QUBIT_A, QUBIT_B)
        corrs[basis] = correlator(probs)
        probs_all[basis] = probs

    zz, xx, yy = corrs["ZZ"], corrs["XX"], corrs["YY"]

    # Bell fidelity from correlators
    if state == "PhiPlus":
        fid = (1 + zz + xx - yy) / 4
    elif state == "PhiMinus":
        fid = (1 + zz - xx + yy) / 4
    elif state == "PsiPlus":
        fid = (1 - zz + xx + yy) / 4
    elif state == "PsiMinus":
        fid = (1 - zz - xx - yy) / 4

    conc = max(0, 2 * fid - 1)

    bell_results[state] = {
        "correlators": corrs,
        "probabilities": probs_all,
        "fidelity": round(fid, 4),
        "concurrence": round(conc, 4),
    }

    print(f"  {state:10s}: ZZ={zz:+.3f}  XX={xx:+.3f}  YY={yy:+.3f}"
          f"  →  F={fid:.3f}  C={conc:.3f}")

fids = [bell_results[s]["fidelity"] for s in bell_states]
concs = [bell_results[s]["concurrence"] for s in bell_states]
mean_fid = sum(fids) / len(fids)
mean_conc = sum(concs) / len(concs)
print(f"\n  Mean fidelity:    {mean_fid:.3f} (range {min(fids):.3f}-{max(fids):.3f})")
print(f"  Mean concurrence: {mean_conc:.3f} (range {min(concs):.3f}-{max(concs):.3f})")
print(f"  Watson published: F = 0.85-0.89, C = 0.73-0.82")

# =============================================================================
# Deutsch-Josza Analysis
# =============================================================================
print("\n--- Deutsch-Josza Algorithm ---")

dj_oracles = {
    "constant_0": "constant",
    "constant_1": "constant",
    "balanced_id": "balanced",
    "balanced_not": "balanced",
}
dj_results = {}

for oracle_name, expected in dj_oracles.items():
    key = f"dj_{oracle_name}"
    counts = RAW[key]
    total = sum(counts.values())

    # MSB-first: qubit j at position n-1-j
    qa_pos = N_QUBITS - 1 - QUBIT_A  # = 4
    p_qa0 = sum(c for bs, c in counts.items() if bs[qa_pos] == "0") / total
    p_qa1 = 1 - p_qa0

    prediction = "constant" if p_qa0 > 0.5 else "balanced"
    success_prob = p_qa0 if expected == "constant" else p_qa1
    correct = prediction == expected

    dj_results[oracle_name] = {
        "expected": expected,
        "prediction": prediction,
        "correct": correct,
        "p_qa0": round(p_qa0, 4),
        "p_qa1": round(p_qa1, 4),
        "success_prob": round(success_prob, 4),
    }

    status = "PASS" if correct else "FAIL"
    print(f"  {oracle_name:14s}: P(qa=0)={p_qa0:.3f}  P(qa=1)={p_qa1:.3f}"
          f"  →  {prediction:8s} (expect {expected:8s})  [{status}]")

dj_correct = sum(1 for d in dj_results.values() if d["correct"])
dj_mean_success = sum(d["success_prob"] for d in dj_results.values()) / len(dj_results)
print(f"\n  Correct: {dj_correct}/4")
print(f"  Mean success probability: {dj_mean_success:.3f}")
print(f"  Watson published: 4/4 correct (with Si/SiGe noise)")

# =============================================================================
# Grover Search Analysis
# =============================================================================
print("\n--- Grover Search ---")

grover_targets = {
    "target_00": "00",
    "target_01": "01",
    "target_10": "10",
    "target_11": "11",
}
grover_results = {}

for target_name, target_bs in grover_targets.items():
    key = f"grover_{target_name}"
    probs = extract_2q_probs(RAW[key], QUBIT_A, QUBIT_B)
    target_prob = probs[target_bs]
    success = target_prob > 0.5

    grover_results[target_name] = {
        "target": target_bs,
        "target_prob": round(target_prob, 4),
        "all_probs": {k: round(v, 4) for k, v in probs.items()},
        "success": success,
    }

    status = "PASS" if success else "FAIL"
    print(f"  {target_name}: P(|{target_bs}>)={target_prob:.3f}  [{status}]"
          f"  (all: {', '.join(f'{k}:{v:.3f}' for k, v in probs.items())})")

grover_probs = [grover_results[t]["target_prob"] for t in grover_targets]
grover_correct = sum(1 for g in grover_results.values() if g["success"])
print(f"\n  Correct: {grover_correct}/4")
print(f"  Mean P(target): {sum(grover_probs)/len(grover_probs):.3f}"
      f" (range {min(grover_probs):.3f}-{max(grover_probs):.3f})")
print(f"  Ideal: P(target) = 1.000")
print(f"  Watson published: mean P(target) ~0.80 (Si/SiGe)")

# =============================================================================
# Summary
# =============================================================================
print("\n" + "=" * 72)
print("  SUMMARY")
print("=" * 72)
print(f"  Bell fidelity:   {mean_fid:.3f} (Watson: 0.85-0.89)")
print(f"  Bell concurrence: {mean_conc:.3f} (Watson: 0.73-0.82)")
print(f"  DJ correct:       {dj_correct}/4   (Watson: 4/4)")
print(f"  DJ success prob:  {dj_mean_success:.3f}")
print(f"  Grover correct:   {grover_correct}/4   (Watson: 4/4)")
print(f"  Grover P(target): {sum(grover_probs)/len(grover_probs):.3f}"
      f"  (Watson: ~0.80)")

# =============================================================================
# Save Results
# =============================================================================
output = {
    "experiment": "Watson et al. 2018 Replication — Tuna-9 Hardware",
    "paper": {
        "title": "A programmable two-qubit quantum processor in silicon",
        "authors": "Watson et al.",
        "journal": "Nature 555, 633-637 (2018)",
        "arxiv": "1708.04214",
    },
    "backend": "Quantum Inspire Tuna-9",
    "qubit_pair": [QUBIT_A, QUBIT_B],
    "shots": SHOTS,
    "bell_tomography": {
        "results": bell_results,
        "mean_fidelity": round(mean_fid, 4),
        "mean_concurrence": round(mean_conc, 4),
        "watson_published": {
            "fidelity_range": [0.85, 0.89],
            "concurrence_range": [0.73, 0.82],
        },
    },
    "deutsch_josza": {
        "results": dj_results,
        "correct": dj_correct,
        "total": 4,
        "mean_success_prob": round(dj_mean_success, 4),
    },
    "grover_search": {
        "results": grover_results,
        "correct": grover_correct,
        "total": 4,
        "mean_target_prob": round(sum(grover_probs)/len(grover_probs), 4),
        "watson_mean_target_prob": 0.80,
    },
    "raw_counts": RAW,
}

outpath = "/Users/dereklomas/haiqu/experiments/results/watson2018-tuna9-hardware.json"
with open(outpath, "w") as f:
    json.dump(output, f, indent=2)

print(f"\n  Saved to {outpath}")
