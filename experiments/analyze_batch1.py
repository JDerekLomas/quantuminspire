"""Analyze batch 1 hardware results from Tuna-9.

Processes:
1. Ising 12-edge (Kim 2023) - 4 circuits with ZNE
2. VQE REM-004 (H2 PS+REM) - 3 basis measurements
3. QV=16 circuits c0, c1 - Heavy Output Fraction
"""
import json
import math
import numpy as np

# ============================================================
# 1. ISING 12-EDGE RESULTS
# ============================================================

ising_results = {
    "d1_f1": {  # depth=1, fold=1 (24 CNOTs)
        "job_id": 425203,
        "cnots": 24,
        "depth": 1,
        "fold": 1,
        "shots": 4096,
        "raw_counts": {"000000000": 2830, "000000001": 47, "000000010": 62, "000000100": 46, "000000101": 2, "000001000": 64, "000001001": 2, "000001010": 24, "000001011": 1, "000001100": 2, "000010000": 56, "000010010": 13, "000010100": 2, "000010110": 2, "000011000": 4, "000011010": 1, "000100000": 49, "000100010": 1, "000100100": 1, "000101000": 3, "001000000": 258, "001000001": 5, "001000010": 4, "001000100": 4, "001001000": 18, "001001010": 7, "001001100": 1, "001010000": 13, "001010010": 1, "001100000": 6, "001101010": 1, "001101110": 1, "010000000": 209, "010000001": 5, "010000010": 4, "010000100": 10, "010001000": 7, "010001010": 1, "010010000": 5, "010010010": 1, "010010100": 1, "010100000": 8, "010110000": 1, "011000000": 16, "011000010": 1, "011000100": 1, "011001000": 1, "100000000": 195, "100000001": 3, "100000010": 3, "100000100": 6, "100001000": 7, "100001001": 1, "100001010": 1, "100010000": 4, "100011000": 1, "100100000": 3, "100100001": 1, "100100100": 1, "101000000": 17, "101000001": 1, "101000010": 1, "101001000": 1, "110000000": 34, "110000001": 1, "110000010": 1, "110000100": 1, "110001010": 1, "110010000": 2, "110100000": 2, "111000000": 3, "111000010": 1, "111001000": 1, "111010000": 1}
    },
    "d3_f1": {  # depth=3, fold=1 (72 CNOTs)
        "job_id": 425204,
        "cnots": 72,
        "depth": 3,
        "fold": 1,
        "shots": 4096,
        "raw_counts": {"000000000": 1478, "000000001": 16, "000000010": 90, "000000011": 1, "000000100": 38, "000000110": 2, "000001000": 586, "000001001": 7, "000001010": 33, "000001100": 21, "000001110": 1, "000010000": 71, "000010010": 29, "000010100": 3, "000010110": 4, "000011000": 26, "000011001": 2, "000011010": 7, "000011100": 1, "000100000": 70, "000100010": 8, "000100100": 5, "000101000": 29, "000101010": 3, "000101100": 3, "000110000": 10, "000110010": 3, "000110100": 1, "000110110": 1, "001000000": 267, "001000001": 3, "001000010": 12, "001000100": 7, "001000110": 1, "001001000": 125, "001001001": 3, "001001010": 10, "001001100": 6, "001001101": 1, "001010000": 19, "001010010": 5, "001010100": 2, "001011000": 10, "001011010": 4, "001011100": 2, "001011110": 2, "001100000": 14, "001101000": 7, "001110000": 1, "010000000": 90, "010000001": 1, "010000010": 5, "010000100": 5, "010001000": 29, "010001010": 3, "010001100": 2, "010010000": 16, "010010001": 1, "010010010": 4, "010010100": 1, "010010110": 1, "010011000": 8, "010011001": 1, "010011010": 1, "010011101": 1, "010100000": 17, "010100010": 1, "010100111": 1, "010101000": 7, "010101100": 1, "010110000": 3, "010111000": 3, "011000000": 14, "011000010": 1, "011000100": 2, "011001000": 16, "011001100": 1, "011010000": 6, "011010010": 1, "011011000": 1, "011011010": 2, "011100000": 7, "011100010": 1, "011101000": 4, "011111000": 3, "011111010": 1, "100000000": 258, "100000001": 4, "100000010": 15, "100000100": 13, "100000110": 1, "100001000": 76, "100001001": 4, "100001010": 9, "100001100": 2, "100001111": 1, "100010000": 17, "100010001": 1, "100010010": 11, "100010100": 2, "100010110": 1, "100011000": 8, "100011001": 1, "100011010": 1, "100011100": 3, "100100000": 10, "100100010": 2, "100100100": 2, "100101000": 7, "100101100": 2, "101000000": 51, "101000010": 3, "101000100": 1, "101001000": 30, "101010000": 11, "101010010": 1, "101011000": 1, "101011010": 1, "101100000": 2, "101100010": 1, "101100100": 1, "101101000": 3, "101101100": 1, "101111000": 1, "110000000": 101, "110000001": 4, "110000010": 4, "110000100": 5, "110000101": 1, "110001000": 32, "110001001": 1, "110001010": 2, "110001100": 2, "110010000": 14, "110010010": 2, "110010100": 1, "110011000": 7, "110100000": 3, "110100100": 1, "110101000": 3, "110101100": 1, "110110000": 1, "111000000": 11, "111001000": 9, "111001001": 1, "111010000": 3, "111010010": 2, "111010011": 1, "111011000": 4, "111100000": 4, "111101000": 3, "111110000": 1, "111111000": 1}
    },
    "d1_f3": {  # depth=1, fold=3 (72 CNOTs) — for ZNE
        "job_id": 425205,
        "cnots": 72,
        "depth": 1,
        "fold": 3,
        "shots": 4096,
        "raw_counts": {"000000000": 1154, "000000001": 14, "000000010": 24, "000000100": 39, "000000101": 3, "000000110": 2, "000001000": 63, "000001001": 1, "000001010": 9, "000001100": 5, "000010000": 43, "000010001": 1, "000010010": 9, "000010100": 10, "000011000": 5, "000011010": 1, "000011100": 2, "000100000": 39, "000100001": 1, "000100100": 11, "000101000": 7, "000101100": 2, "000110000": 1, "000110010": 1, "000110100": 3, "000111010": 2, "000111110": 1, "001000000": 379, "001000001": 7, "001000010": 13, "001000100": 13, "001001000": 111, "001001001": 3, "001001010": 15, "001001100": 4, "001010000": 40, "001010010": 12, "001010100": 13, "001010110": 1, "001011000": 5, "001011010": 1, "001100000": 16, "001100100": 2, "001100110": 1, "001101000": 3, "001101010": 3, "001101100": 4, "001110000": 1, "001110100": 4, "001111100": 1, "010000000": 342, "010000001": 6, "010000010": 12, "010000011": 1, "010000100": 13, "010000101": 1, "010000110": 1, "010001000": 21, "010001010": 2, "010001100": 2, "010010000": 33, "010010010": 4, "010010100": 5, "010011000": 11, "010011010": 1, "010011110": 1, "010100000": 40, "010100010": 2, "010100100": 7, "010100101": 1, "010100110": 1, "010101000": 5, "010110000": 2, "010110100": 1, "011000000": 52, "011000001": 1, "011000010": 2, "011000100": 5, "011001000": 14, "011010000": 19, "011010010": 1, "011010100": 4, "011011000": 2, "011011100": 1, "011100000": 3, "011101000": 1, "011110100": 1, "100000000": 592, "100000001": 5, "100000010": 16, "100000011": 2, "100000100": 22, "100000110": 1, "100001000": 32, "100001001": 1, "100001010": 4, "100001100": 1, "100001101": 1, "100001110": 1, "100010000": 12, "100010010": 4, "100010100": 4, "100010110": 1, "100011000": 2, "100100000": 21, "100100100": 3, "100101100": 1, "100110000": 4, "100110100": 2, "100110110": 1, "100111100": 1, "101000000": 90, "101000001": 1, "101000010": 4, "101000100": 7, "101001000": 18, "101001010": 2, "101001100": 1, "101010000": 13, "101010010": 7, "101010100": 2, "101100000": 8, "101100100": 1, "101101000": 1, "101110000": 2, "101110001": 1, "101110100": 1, "110000000": 194, "110000001": 1, "110000010": 4, "110000100": 10, "110001000": 9, "110001010": 6, "110010000": 21, "110010010": 2, "110010100": 4, "110011000": 4, "110011010": 2, "110011100": 1, "110100000": 13, "110100100": 7, "110101000": 1, "110101010": 1, "110110000": 2, "110110100": 1, "110111010": 1, "111000000": 70, "111000001": 1, "111000010": 6, "111000100": 4, "111000110": 1, "111001000": 31, "111001010": 5, "111001100": 1, "111010000": 38, "111010010": 9, "111010100": 6, "111011000": 1, "111100000": 11, "111100100": 3, "111101000": 3, "111101100": 1, "111101110": 1, "111111100": 1}
    },
    "d5_f1": {  # depth=5, fold=1 (120 CNOTs)
        "job_id": 425208,
        "cnots": 120,
        "depth": 5,
        "fold": 1,
        "shots": 4096,
        "raw_counts": {"000000000": 879, "000000001": 13, "000000010": 62, "000000100": 37, "000000101": 2, "000000110": 2, "000001000": 459, "000001001": 16, "000001010": 46, "000001011": 1, "000001100": 24, "000001110": 3, "000010000": 97, "000010001": 1, "000010010": 20, "000010011": 1, "000010100": 8, "000010110": 1, "000011000": 29, "000011001": 2, "000011010": 9, "000011100": 3, "000100000": 66, "000100010": 4, "000100100": 10, "000100110": 3, "000101000": 46, "000101010": 7, "000101100": 4, "000101110": 1, "000110000": 10, "000110010": 2, "000110100": 1, "000110110": 1, "000111000": 4, "001000000": 214, "001000001": 7, "001000010": 26, "001000011": 1, "001000100": 15, "001000110": 1, "001000111": 1, "001001000": 259, "001001001": 7, "001001010": 31, "001001100": 4, "001010000": 38, "001010010": 16, "001010011": 1, "001010100": 4, "001010110": 1, "001011000": 22, "001011010": 9, "001011110": 4, "001100000": 19, "001100001": 1, "001100010": 3, "001100100": 3, "001100110": 1, "001101000": 15, "001101001": 1, "001101010": 1, "001101100": 1, "001110000": 4, "001110010": 1, "001110100": 2, "001110101": 1, "001111000": 2, "001111010": 1, "010000000": 106, "010000001": 2, "010000010": 6, "010000100": 7, "010001000": 61, "010001010": 7, "010001100": 3, "010001110": 1, "010010000": 25, "010010010": 2, "010011000": 8, "010011010": 5, "010011100": 2, "010011110": 2, "010100000": 24, "010100010": 3, "010100011": 1, "010100100": 3, "010101000": 8, "010101010": 1, "010101100": 3, "010101110": 1, "010110000": 2, "010110100": 1, "010111000": 2, "010111010": 1, "010111110": 1, "011000000": 33, "011000010": 2, "011000100": 6, "011001000": 35, "011001001": 1, "011001010": 3, "011001100": 1, "011010000": 11, "011010010": 2, "011010100": 2, "011010110": 1, "011011000": 4, "011011010": 4, "011011011": 1, "011100000": 7, "011100010": 2, "011100110": 1, "011101000": 3, "011101010": 1, "011101100": 2, "011101110": 1, "011110000": 1, "011111000": 1, "100000000": 234, "100000001": 5, "100000010": 22, "100000100": 11, "100000110": 2, "100001000": 150, "100001001": 2, "100001010": 8, "100001011": 1, "100001100": 13, "100010000": 28, "100010001": 1, "100010010": 7, "100010100": 7, "100011000": 20, "100011001": 1, "100011010": 2, "100011100": 3, "100100000": 13, "100100010": 1, "100100100": 3, "100101000": 20, "100101100": 3, "100110000": 5, "100110010": 2, "100110100": 3, "100111000": 1, "100111100": 2, "101000000": 59, "101000001": 1, "101000010": 4, "101000100": 5, "101001000": 57, "101001001": 1, "101001010": 7, "101001011": 1, "101001100": 2, "101010000": 13, "101010010": 4, "101010100": 2, "101010110": 1, "101011000": 11, "101011010": 5, "101011100": 2, "101011110": 1, "101100000": 1, "101100001": 1, "101100010": 1, "101101000": 7, "101101100": 2, "101110000": 2, "101110010": 1, "101110100": 1, "101111000": 1, "101111010": 1, "101111110": 2, "110000000": 95, "110000001": 2, "110000010": 6, "110000011": 1, "110000100": 6, "110001000": 50, "110001001": 2, "110001010": 9, "110001100": 4, "110010000": 14, "110010010": 5, "110010100": 2, "110010110": 1, "110011000": 9, "110011010": 4, "110100000": 21, "110100010": 2, "110100100": 1, "110101000": 10, "110101100": 1, "110110000": 2, "110110010": 1, "110111000": 2, "110111010": 1, "110111100": 1, "111000000": 17, "111000010": 2, "111000100": 3, "111001000": 22, "111001001": 1, "111001010": 2, "111001101": 1, "111010000": 7, "111010001": 1, "111010010": 2, "111011000": 4, "111011010": 1, "111100000": 2, "111101000": 3, "111101010": 1, "111110000": 1, "111110010": 1, "111111010": 2, "111111100": 1}
    },
}

def compute_mz_per_qubit(counts, n_qubits=9):
    """Compute per-qubit Z expectation from MSB-first bitstrings."""
    total = sum(counts.values())
    mz = [0.0] * n_qubits
    for bitstring, count in counts.items():
        for q in range(n_qubits):
            # MSB-first: str[pos] = q[N-1-pos]
            pos = n_qubits - 1 - q
            bit = int(bitstring[pos])
            mz[q] += (-1)**bit * count / total
    return mz

def compute_total_mz(counts, n_qubits=9):
    """Compute average magnetization Mz = (1/N) sum_i <Z_i>."""
    mz = compute_mz_per_qubit(counts, n_qubits)
    return sum(mz) / n_qubits

print("=" * 70)
print("  ISING 12-EDGE (Kim 2023) — Tuna-9 Hardware Results")
print("=" * 70)

ising_analysis = {}
for label, data in ising_results.items():
    counts = data["raw_counts"]
    total = data["shots"]
    p_ground = counts.get("000000000", 0) / total
    mz_per_q = compute_mz_per_qubit(counts)
    mz_total = compute_total_mz(counts)

    ising_analysis[label] = {
        "p_ground_state": round(p_ground, 4),
        "mz_total": round(mz_total, 6),
        "mz_per_qubit": [round(m, 4) for m in mz_per_q],
    }

    print(f"\n  {label} ({data['cnots']} CNOTs, depth={data['depth']}, fold={data['fold']})")
    print(f"    P(|000000000⟩) = {counts.get('000000000', 0)}/{total} = {p_ground:.1%}")
    print(f"    Total Mz = {mz_total:.4f} (ideal = 1.0)")
    print(f"    Per-qubit Mz: {['%.3f' % m for m in mz_per_q]}")

# ZNE: linear extrapolation
# fold=1 gives Mz(1), fold=3 gives Mz(3)
# Linear: Mz(0) = Mz(1) + [Mz(1) - Mz(3)] * 1/2
mz_f1 = ising_analysis["d1_f1"]["mz_total"]
mz_f3 = ising_analysis["d1_f3"]["mz_total"]
mz_zne = mz_f1 + (mz_f1 - mz_f3) * 0.5
improvement = mz_zne / mz_f1 if mz_f1 > 0 else 0

print(f"\n  ZNE (linear extrapolation from fold=1,3):")
print(f"    Mz(fold=1) = {mz_f1:.4f}")
print(f"    Mz(fold=3) = {mz_f3:.4f}")
print(f"    Mz(ZNE→0) = {mz_zne:.4f}")
print(f"    Improvement: {improvement:.2f}x")

# Per-qubit ZNE
mz_f1_per = ising_analysis["d1_f1"]["mz_per_qubit"]
mz_f3_per = ising_analysis["d1_f3"]["mz_per_qubit"]
mz_zne_per = [f1 + (f1 - f3) * 0.5 for f1, f3 in zip(mz_f1_per, mz_f3_per)]
print(f"    ZNE per-qubit: {['%.3f' % m for m in mz_zne_per]}")

# ============================================================
# 2. VQE REM-004 RESULTS
# ============================================================

print("\n" + "=" * 70)
print("  VQE H2 PS+REM-004 — Tuna-9 Hardware Results")
print("=" * 70)

vqe_004_counts = {
    "z_basis": {"job_id": 425234, "counts": {"00000": 218, "00001": 4, "00010": 3, "00100": 3634, "00101": 55, "00110": 46, "00111": 1, "01100": 16, "01110": 1, "10000": 67, "10001": 2, "10100": 48, "10101": 1}},
    "x_basis": {"job_id": 425235, "counts": {"00000": 832, "00001": 10, "00010": 17, "00100": 1198, "00101": 13, "00110": 10, "01000": 7, "01100": 2, "10000": 1194, "10001": 22, "10010": 21, "10100": 738, "10101": 9, "10110": 14, "11000": 8, "11100": 1}},
    "y_basis": {"job_id": 425236, "counts": {"00000": 775, "00001": 6, "00010": 23, "00100": 1106, "00101": 12, "00110": 31, "01000": 4, "01100": 4, "10000": 1193, "10001": 12, "10010": 32, "10100": 857, "10101": 10, "10110": 21, "11000": 6, "11100": 4}},
}

# VQE coefficients from queue file
g0 = -0.321124  # IIII offset
g1 = 0.397937   # IIIZ (Z on q0 in logical = q2 physical)
g2 = -0.397937  # IIZI (Z on q1 in logical = q4 physical)
g3 = 0.0        # IIZZ (always 0 for H2 at this R)
g4 = 0.090466   # IXIX (XX)
g5 = 0.090466   # IYIY (YY)
fci_energy = -1.137306

# For 5-qubit MSB-first: "abcde" → a=q4, b=q3, c=q2, d=q1, e=q0
# Physical qubits used: q2 and q4
# q2 → str position 2 (middle), q4 → str position 0 (leftmost)

def extract_q2_q4(bitstring):
    """Extract q2 and q4 from 5-qubit MSB-first bitstring."""
    # MSB-first: str[0]=q4, str[1]=q3, str[2]=q2, str[3]=q1, str[4]=q0
    q4 = int(bitstring[0])
    q2 = int(bitstring[2])
    return q2, q4

def post_select(counts, n_qubits=5, active_qubits=[2, 4]):
    """Post-select: keep only shots where non-active qubits are 0."""
    filtered = {}
    total_raw = sum(counts.values())
    for bitstring, count in counts.items():
        # Check non-active qubits are 0
        valid = True
        for q in range(n_qubits):
            if q not in active_qubits:
                pos = n_qubits - 1 - q
                if int(bitstring[pos]) != 0:
                    valid = False
                    break
        if valid:
            q2, q4 = extract_q2_q4(bitstring)
            key = f"{q2}{q4}"
            filtered[key] = filtered.get(key, 0) + count
    total_ps = sum(filtered.values())
    return filtered, total_ps, total_raw

# Z-basis: measure ZZ, ZI, IZ
z_ps, z_total, z_raw = post_select(vqe_004_counts["z_basis"]["counts"])
print(f"\n  Z-basis (job {vqe_004_counts['z_basis']['job_id']}):")
print(f"    Post-selected: {z_total}/{z_raw} ({z_total/z_raw:.1%})")
for k, v in sorted(z_ps.items()):
    print(f"    |{k}⟩ = {v} ({v/z_total:.1%})")

# Compute <ZI>, <IZ>, <ZZ> from Z-basis
zi = sum((-1)**int(k[0]) * v for k, v in z_ps.items()) / z_total  # Z on q2
iz = sum((-1)**int(k[1]) * v for k, v in z_ps.items()) / z_total  # Z on q4
zz = sum((-1)**(int(k[0])+int(k[1])) * v for k, v in z_ps.items()) / z_total

# X-basis: measure XX
x_ps, x_total, x_raw = post_select(vqe_004_counts["x_basis"]["counts"])
print(f"\n  X-basis (job {vqe_004_counts['x_basis']['job_id']}):")
print(f"    Post-selected: {x_total}/{x_raw} ({x_total/x_raw:.1%})")
for k, v in sorted(x_ps.items()):
    print(f"    |{k}⟩ = {v} ({v/x_total:.1%})")

xx = sum((-1)**(int(k[0])+int(k[1])) * v for k, v in x_ps.items()) / x_total

# Y-basis: measure YY
y_ps, y_total, y_raw = post_select(vqe_004_counts["y_basis"]["counts"])
print(f"\n  Y-basis (job {vqe_004_counts['y_basis']['job_id']}):")
print(f"    Post-selected: {y_total}/{y_raw} ({y_total/y_raw:.1%})")
for k, v in sorted(y_ps.items()):
    print(f"    |{k}⟩ = {v} ({v/y_total:.1%})")

yy = sum((-1)**(int(k[0])+int(k[1])) * v for k, v in y_ps.items()) / y_total

# Compute energy
energy = g0 + g1 * zi + g2 * iz + g3 * zz + g4 * xx + g5 * yy

print(f"\n  Expectation values:")
print(f"    <ZI> = {zi:.4f}, <IZ> = {iz:.4f}, <ZZ> = {zz:.4f}")
print(f"    <XX> = {xx:.4f}, <YY> = {yy:.4f}")
print(f"\n  Energy = {g0:.6f} + {g1:.6f}*{zi:.4f} + {g2:.6f}*{iz:.4f}")
print(f"         + {g3:.6f}*{zz:.4f} + {g4:.6f}*{xx:.4f} + {g5:.6f}*{yy:.4f}")
print(f"         = {energy:.6f} Ha")
print(f"  FCI    = {fci_energy:.6f} Ha")
print(f"  Error  = {abs(energy - fci_energy)*1000:.2f} mHa")
print(f"  Error  = {abs(energy - fci_energy)*627.509:.2f} kcal/mol")
print(f"  Chemical accuracy (<1.6 mHa): {'YES' if abs(energy - fci_energy)*1000 < 1.6 else 'NO'}")

# ============================================================
# 3. QV=16 HARDWARE RESULTS (c0, c1)
# ============================================================

print("\n" + "=" * 70)
print("  QV=16 — Tuna-9 Hardware Results (circuits 0-1)")
print("=" * 70)

# Ideal distributions from emulator
qv_ideal = {
    "qv16_c0": {"0000": 0.047344652022662415, "0001": 0.35800329630033684, "0010": 0.05461385504104445, "0011": 0.07680900350632, "0100": 0.028472868271083352, "0101": 0.2153016288153065, "0110": 0.032844535421136085, "0111": 0.04619260139079256, "1000": 0.009782064904175774, "1001": 0.07396847015883572, "1010": 0.011283983551574566, "1011": 0.015869810536662893, "1100": 0.0026031475451367414, "1101": 0.01968406909969466, "1110": 0.003002829603911706, "1111": 0.0042231838313262745},
    "qv16_c1": {"0000": 0.013753283301775412, "0001": 0.06747977669781358, "0010": 0.13010857833089595, "0011": 0.13473326050012466, "0100": 0.05703910665992843, "0101": 0.0020579651782805393, "0110": 0.026176321821084647, "0111": 0.09086717227093101, "1000": 0.0023838762000456684, "1001": 0.0057599157593149625, "1010": 0.12600442642589538, "1011": 0.03514723473906647, "1100": 0.11051647669023272, "1101": 0.02968474825069336, "1110": 0.14668801197235454, "1111": 0.02159984520156237},
}

qv_hardware = {
    "qv16_c0": {"job_id": 425239, "counts": {"0000": 265, "0001": 927, "0010": 163, "0011": 168, "0100": 175, "0101": 653, "0110": 133, "0111": 112, "1000": 164, "1001": 593, "1010": 126, "1011": 113, "1100": 83, "1101": 324, "1110": 49, "1111": 48}},
    "qv16_c1": {"job_id": 425241, "counts": {"0000": 179, "0001": 222, "0010": 560, "0011": 390, "0100": 266, "0101": 89, "0110": 220, "0111": 301, "1000": 110, "1001": 58, "1010": 279, "1011": 208, "1100": 434, "1101": 244, "1110": 266, "1111": 270}},
}

for circuit_name in ["qv16_c0", "qv16_c1"]:
    ideal = qv_ideal[circuit_name]
    hw = qv_hardware[circuit_name]
    counts = hw["counts"]
    total = sum(counts.values())

    # Compute median of ideal distribution
    sorted_probs = sorted(ideal.values())
    median_prob = sorted_probs[len(sorted_probs) // 2]

    # Heavy outputs: bitstrings with ideal probability >= median
    heavy_bitstrings = {bs for bs, p in ideal.items() if p >= median_prob}

    # Hardware HOF
    heavy_count = sum(counts.get(bs, 0) for bs in heavy_bitstrings)
    hof = heavy_count / total

    print(f"\n  {circuit_name} (job {hw['job_id']}):")
    print(f"    Ideal median probability: {median_prob:.6f}")
    print(f"    Heavy bitstrings: {sorted(heavy_bitstrings)}")
    print(f"    Heavy count: {heavy_count}/{total}")
    print(f"    HOF = {hof:.4f} (threshold = 0.6667)")
    print(f"    PASS: {'YES' if hof > 2/3 else 'NO'}")

# ============================================================
# Save all results
# ============================================================

output = {
    "experiment": "kim2023-ising-12edge-tuna9-hardware",
    "description": "Kicked Ising model on full 12-edge Tuna-9 topology. "
                   "Clifford point (theta_j=-pi/4, theta_h=0). "
                   "Depth sweep d=1,3,5 plus ZNE fold=3.",
    "backend": "tuna-9",
    "date": "2026-02-13",
    "topology": [[0,1],[0,2],[1,3],[1,4],[2,4],[2,5],[3,6],[4,6],[4,7],[5,7],[6,8],[7,8]],
    "results": {},
}

for label, data in ising_results.items():
    a = ising_analysis[label]
    output["results"][label] = {
        "job_id": data["job_id"],
        "cnots": data["cnots"],
        "depth": data["depth"],
        "fold": data["fold"],
        "shots": data["shots"],
        "p_ground_state": a["p_ground_state"],
        "mz_total": a["mz_total"],
        "mz_per_qubit": a["mz_per_qubit"],
        "raw_counts": data["raw_counts"],
    }

output["zne"] = {
    "method": "linear",
    "fold_points": [1, 3],
    "mz_fold1": round(mz_f1, 6),
    "mz_fold3": round(mz_f3, 6),
    "mz_extrapolated": round(mz_zne, 6),
    "improvement_factor": round(improvement, 3),
    "mz_zne_per_qubit": [round(m, 4) for m in mz_zne_per],
}

with open("/Users/dereklomas/haiqu/experiments/results/kim2023-ising-tuna9-hardware.json", "w") as f:
    json.dump(output, f, indent=2)
print(f"\n  Saved Ising results to experiments/results/kim2023-ising-tuna9-hardware.json")

# Save VQE REM-004
vqe_output = {
    "id": "vqe-tuna9-rem-004",
    "experiment": "VQE H2 PS+REM run 004",
    "backend": "tuna-9",
    "date": "2026-02-13",
    "parameters": {
        "shots": 4096,
        "bond_distance": 0.735,
        "alpha": -0.2234,
        "qubits": [2, 4],
        "g0": g0, "g1": g1, "g2": g2, "g3": g3, "g4": g4, "g5": g5,
        "fci_energy": fci_energy,
    },
    "raw_counts": {
        "z_basis": {"job_id": 425234, "counts": vqe_004_counts["z_basis"]["counts"]},
        "x_basis": {"job_id": 425235, "counts": vqe_004_counts["x_basis"]["counts"]},
        "y_basis": {"job_id": 425236, "counts": vqe_004_counts["y_basis"]["counts"]},
    },
    "post_selected": {
        "z_basis": {"counts": z_ps, "total": z_total, "acceptance": round(z_total/z_raw, 4)},
        "x_basis": {"counts": x_ps, "total": x_total, "acceptance": round(x_total/x_raw, 4)},
        "y_basis": {"counts": y_ps, "total": y_total, "acceptance": round(y_total/y_raw, 4)},
    },
    "expectation_values": {
        "ZI": round(zi, 6),
        "IZ": round(iz, 6),
        "ZZ": round(zz, 6),
        "XX": round(xx, 6),
        "YY": round(yy, 6),
    },
    "energy": round(energy, 6),
    "error_mHa": round(abs(energy - fci_energy) * 1000, 2),
    "error_kcal_mol": round(abs(energy - fci_energy) * 627.509, 2),
    "chemical_accuracy": abs(energy - fci_energy) * 1000 < 1.6,
}

with open("/Users/dereklomas/haiqu/experiments/results/vqe-tuna9-rem-004.json", "w") as f:
    json.dump(vqe_output, f, indent=2)
print(f"  Saved VQE REM-004 to experiments/results/vqe-tuna9-rem-004.json")
