"""
Analyze quantum poetry Bell test results from Tuna-9 hardware.

5 jobs:
  426263: ZZ (base poem circuit)
  426264: ZW = A0B0
  426265: ZV = A0B1
  426266: XW = A1B0
  426267: XV = A1B1

CHSH: S = E(A0B0) + E(A0B1) + E(A1B0) - E(A1B1)
Classical bound: |S| <= 2
Quantum bound:  |S| <= 2*sqrt(2) ~ 2.828

MSB-first bitstring convention (9-bit string s):
  s[0]=q8, s[1]=q7, s[2]=q6, s[3]=q5, s[4]=q4, s[5]=q3, s[6]=q2, s[7]=q1, s[8]=q0

Bell pairs (alice, bob bit positions in bitstring):
  Pair 0 (edge 2-5): alice=s[6], bob=s[3]
  Pair 1 (edge 4-6): alice=s[4], bob=s[2]
  Pair 2 (edge 7-8): alice=s[1], bob=s[0]
"""

import json
import math
import numpy as np

# ── Raw histogram data ──────────────────────────────────────────────────────

raw_zz = {"000000000": 72, "000000001": 59, "000000010": 55, "000000011": 73, "000000100": 2, "000000101": 1, "000000110": 4, "000000111": 1, "000001000": 57, "000001001": 58, "000001010": 63, "000001011": 50, "000001100": 1, "000001110": 2, "000001111": 1, "000010000": 2, "000010001": 2, "000010010": 1, "000010011": 2, "000011000": 4, "000011001": 2, "000011010": 3, "000011011": 1, "000011100": 1, "000100000": 3, "000100001": 2, "000100010": 7, "000100100": 61, "000100101": 57, "000100110": 55, "000100111": 61, "000101000": 4, "000101001": 3, "000101010": 4, "000101011": 2, "000101100": 44, "000101101": 47, "000101110": 64, "000101111": 48, "000110000": 2, "000110100": 5, "000110101": 4, "000110110": 1, "000110111": 2, "000111010": 1, "000111011": 1, "000111100": 2, "000111101": 2, "000111110": 1, "000111111": 4, "001000000": 1, "001000001": 1, "001000010": 3, "001000011": 2, "001001000": 3, "001001001": 2, "001001011": 2, "001010000": 59, "001010001": 61, "001010010": 82, "001010011": 58, "001010100": 2, "001010101": 3, "001010111": 2, "001011000": 46, "001011001": 42, "001011010": 57, "001011011": 56, "001011100": 3, "001011101": 2, "001011110": 3, "001100001": 1, "001100011": 1, "001100100": 3, "001100101": 2, "001100110": 1, "001100111": 1, "001101101": 2, "001101110": 1, "001101111": 1, "001110000": 6, "001110001": 3, "001110010": 7, "001110011": 1, "001110100": 59, "001110101": 51, "001110110": 52, "001110111": 51, "001111000": 1, "001111001": 1, "001111010": 1, "001111011": 1, "001111100": 57, "001111101": 52, "001111110": 66, "001111111": 49, "010000000": 2, "010000001": 4, "010000010": 4, "010000011": 4, "010000111": 1, "010001000": 4, "010001001": 4, "010001010": 2, "010001011": 5, "010011010": 1, "010100100": 6, "010100101": 2, "010100110": 7, "010100111": 1, "010101001": 1, "010101010": 1, "010101011": 1, "010101100": 5, "010101101": 1, "010101110": 6, "010101111": 3, "010110101": 2, "010111111": 1, "011010000": 2, "011010001": 3, "011010010": 4, "011010011": 4, "011011000": 4, "011011001": 4, "011011010": 1, "011011011": 5, "011100011": 1, "011100101": 1, "011101110": 1, "011101111": 1, "011110000": 1, "011110100": 7, "011110101": 7, "011110110": 7, "011110111": 7, "011111001": 1, "011111100": 4, "011111101": 3, "011111110": 8, "011111111": 4, "100000000": 4, "100000001": 3, "100000010": 2, "100000011": 1, "100001000": 4, "100001001": 3, "100001010": 1, "100001011": 3, "100010011": 2, "100011000": 1, "100011011": 1, "100100100": 2, "100100101": 1, "100100110": 2, "100100111": 5, "100101100": 3, "100101101": 3, "100101110": 1, "100101111": 1, "100110101": 3, "100110110": 1, "101000011": 1, "101001011": 1, "101010000": 1, "101010001": 2, "101010010": 3, "101010011": 2, "101010110": 1, "101011001": 2, "101011010": 1, "101011011": 2, "101100101": 1, "101101100": 1, "101110100": 2, "101110101": 3, "101110110": 6, "101110111": 1, "101111100": 3, "101111101": 3, "101111110": 6, "101111111": 7, "110000000": 72, "110000001": 56, "110000010": 56, "110000011": 54, "110000100": 1, "110000101": 1, "110000110": 2, "110000111": 1, "110001000": 52, "110001001": 57, "110001010": 57, "110001011": 41, "110001100": 3, "110001101": 2, "110001110": 2, "110001111": 2, "110010000": 4, "110010001": 3, "110010010": 2, "110010011": 2, "110011001": 3, "110100000": 7, "110100001": 5, "110100010": 6, "110100011": 2, "110100100": 60, "110100101": 60, "110100110": 61, "110100111": 55, "110101000": 2, "110101001": 3, "110101010": 1, "110101011": 3, "110101100": 50, "110101101": 49, "110101110": 53, "110101111": 52, "110110100": 3, "110110101": 2, "110110110": 1, "110110111": 1, "110111100": 2, "110111101": 3, "110111110": 1, "110111111": 2, "111000000": 2, "111000011": 3, "111001000": 3, "111001001": 1, "111001010": 1, "111001011": 2, "111010000": 71, "111010001": 57, "111010010": 67, "111010011": 54, "111010100": 2, "111010101": 3, "111010110": 2, "111010111": 5, "111011000": 46, "111011001": 64, "111011010": 45, "111011011": 44, "111011100": 4, "111011101": 3, "111011110": 1, "111011111": 3, "111100100": 2, "111100101": 4, "111100110": 3, "111100111": 3, "111101100": 4, "111101101": 1, "111101110": 2, "111101111": 3, "111110000": 3, "111110001": 2, "111110010": 9, "111110011": 3, "111110100": 58, "111110101": 60, "111110110": 52, "111110111": 41, "111111000": 2, "111111001": 3, "111111010": 3, "111111011": 4, "111111100": 49, "111111101": 43, "111111110": 53, "111111111": 40}

raw_zw = {"000000000": 50, "000000001": 41, "000000010": 36, "000000011": 38, "000000100": 2, "000000101": 6, "000000110": 8, "000000111": 10, "000001000": 30, "000001001": 24, "000001010": 34, "000001011": 36, "000001100": 9, "000001101": 2, "000001110": 8, "000001111": 9, "000010000": 11, "000010001": 4, "000010010": 4, "000010011": 11, "000010100": 2, "000010110": 1, "000010111": 1, "000011000": 4, "000011001": 6, "000011010": 5, "000011011": 8, "000011100": 5, "000011101": 1, "000011110": 1, "000011111": 4, "000100000": 8, "000100001": 5, "000100010": 7, "000100011": 5, "000100100": 43, "000100101": 43, "000100110": 42, "000100111": 34, "000101000": 6, "000101001": 4, "000101010": 11, "000101011": 8, "000101100": 34, "000101101": 25, "000101110": 35, "000101111": 32, "000110000": 2, "000110010": 1, "000110011": 1, "000110100": 7, "000110101": 7, "000110110": 9, "000110111": 14, "000111000": 1, "000111001": 1, "000111010": 4, "000111011": 2, "000111100": 8, "000111101": 5, "000111110": 11, "000111111": 7, "001000000": 8, "001000001": 9, "001000010": 10, "001000011": 3, "001000100": 2, "001000110": 2, "001000111": 3, "001001000": 10, "001001001": 12, "001001010": 3, "001001011": 2, "001001100": 1, "001001110": 1, "001001111": 1, "001010000": 54, "001010001": 39, "001010010": 52, "001010011": 39, "001010100": 9, "001010101": 9, "001010110": 12, "001010111": 10, "001011000": 33, "001011001": 31, "001011010": 22, "001011011": 26, "001011100": 10, "001011101": 11, "001011110": 11, "001011111": 5, "001100000": 2, "001100001": 2, "001100010": 3, "001100011": 2, "001100100": 7, "001100101": 8, "001100110": 4, "001100111": 10, "001101000": 1, "001101010": 2, "001101011": 1, "001101100": 13, "001101101": 5, "001101110": 7, "001101111": 4, "001110000": 10, "001110001": 4, "001110010": 8, "001110011": 5, "001110100": 46, "001110101": 36, "001110110": 42, "001110111": 38, "001111000": 5, "001111001": 3, "001111010": 14, "001111011": 4, "001111100": 39, "001111101": 34, "001111110": 38, "001111111": 21, "010000000": 13, "010000001": 9, "010000010": 15, "010000011": 10, "010000100": 1, "010000101": 1, "010000110": 1, "010000111": 1, "010001000": 5, "010001001": 4, "010001010": 11, "010001011": 10, "010001100": 1, "010001101": 2, "010001110": 1, "010001111": 1, "010010000": 1, "010010001": 2, "010010010": 1, "010010011": 2, "010010101": 1, "010010110": 1, "010011000": 1, "010011001": 4, "010011010": 3, "010011011": 1, "010011110": 2, "010100000": 2, "010100001": 2, "010100010": 3, "010100100": 13, "010100101": 13, "010100110": 10, "010100111": 9, "010101000": 2, "010101001": 1, "010101010": 4, "010101100": 7, "010101101": 11, "010101110": 10, "010101111": 5, "010110000": 1, "010110011": 1, "010110100": 6, "010110101": 3, "010110110": 2, "010110111": 1, "010111100": 1, "010111101": 2, "011000000": 4, "011000010": 1, "011000100": 1, "011000101": 1, "011000110": 1, "011000111": 1, "011001001": 7, "011001010": 1, "011001011": 1, "011001100": 1, "011001111": 1, "011010000": 12, "011010001": 4, "011010010": 5, "011010011": 11, "011010100": 2, "011010101": 4, "011010110": 2, "011010111": 2, "011011000": 8, "011011001": 7, "011011010": 3, "011011011": 7, "011011100": 1, "011011101": 3, "011011110": 3, "011011111": 2, "011100011": 1, "011100100": 3, "011100111": 1, "011101001": 2, "011101100": 2, "011101101": 2, "011101110": 2, "011101111": 2, "011110000": 3, "011110001": 4, "011110010": 1, "011110100": 15, "011110101": 11, "011110110": 9, "011110111": 9, "011111000": 3, "011111001": 2, "011111100": 9, "011111101": 9, "011111110": 7, "011111111": 5, "100000000": 7, "100000001": 11, "100000010": 11, "100000011": 10, "100000101": 2, "100000110": 2, "100001000": 3, "100001001": 2, "100001010": 5, "100001011": 9, "100001100": 3, "100001101": 2, "100001110": 1, "100001111": 1, "100010000": 1, "100010001": 3, "100010010": 2, "100010011": 1, "100010100": 1, "100010110": 1, "100010111": 1, "100011000": 3, "100011001": 2, "100011010": 1, "100011011": 1, "100011100": 3, "100100000": 3, "100100001": 2, "100100010": 2, "100100011": 3, "100100100": 10, "100100101": 10, "100100110": 6, "100100111": 6, "100101000": 1, "100101010": 1, "100101100": 5, "100101101": 8, "100101110": 11, "100101111": 6, "100110000": 1, "100110001": 2, "100110010": 1, "100110100": 2, "100110101": 2, "100110110": 2, "100111000": 1, "100111100": 2, "100111101": 2, "100111110": 1, "100111111": 1, "101000000": 1, "101000001": 3, "101000010": 1, "101000100": 1, "101000111": 1, "101001000": 2, "101001001": 1, "101001010": 2, "101001011": 2, "101001100": 1, "101001101": 1, "101010000": 8, "101010001": 10, "101010010": 9, "101010011": 5, "101010100": 2, "101010101": 4, "101010110": 2, "101010111": 1, "101011000": 7, "101011001": 10, "101011010": 6, "101011011": 5, "101011110": 1, "101100010": 1, "101100011": 2, "101100100": 3, "101100101": 3, "101100110": 3, "101100111": 4, "101101001": 1, "101101100": 2, "101101110": 2, "101101111": 1, "101110001": 2, "101110010": 1, "101110011": 3, "101110100": 13, "101110101": 12, "101110110": 8, "101110111": 10, "101111000": 2, "101111001": 3, "101111010": 1, "101111011": 1, "101111100": 8, "101111101": 10, "101111110": 8, "101111111": 11, "110000000": 31, "110000001": 40, "110000010": 31, "110000011": 34, "110000100": 7, "110000101": 6, "110000110": 9, "110000111": 8, "110001000": 36, "110001001": 27, "110001010": 34, "110001011": 26, "110001100": 3, "110001101": 12, "110001110": 11, "110001111": 5, "110010000": 10, "110010001": 7, "110010010": 7, "110010011": 8, "110010100": 5, "110010101": 1, "110010110": 1, "110011000": 5, "110011001": 5, "110011010": 9, "110011011": 5, "110011101": 1, "110011110": 1, "110011111": 2, "110100000": 5, "110100001": 7, "110100010": 14, "110100011": 6, "110100100": 56, "110100101": 42, "110100110": 31, "110100111": 41, "110101000": 2, "110101001": 12, "110101010": 8, "110101011": 5, "110101100": 28, "110101101": 33, "110101110": 28, "110101111": 32, "110110000": 3, "110110100": 5, "110110101": 6, "110110110": 4, "110110111": 6, "110111000": 1, "110111001": 1, "110111010": 3, "110111011": 1, "110111100": 9, "110111101": 3, "110111110": 4, "110111111": 6, "111000000": 7, "111000001": 12, "111000010": 4, "111000011": 10, "111000100": 2, "111000101": 1, "111000110": 6, "111001000": 8, "111001001": 5, "111001010": 7, "111001011": 9, "111001110": 1, "111010000": 39, "111010001": 34, "111010010": 41, "111010011": 41, "111010100": 11, "111010101": 5, "111010110": 6, "111010111": 7, "111011000": 34, "111011001": 35, "111011010": 29, "111011011": 27, "111011100": 5, "111011101": 9, "111011110": 4, "111011111": 4, "111100000": 4, "111100001": 4, "111100010": 3, "111100011": 2, "111100100": 10, "111100101": 7, "111100110": 11, "111100111": 8, "111101000": 1, "111101001": 1, "111101010": 1, "111101011": 1, "111101100": 5, "111101101": 7, "111101110": 8, "111101111": 4, "111110000": 4, "111110001": 6, "111110010": 7, "111110011": 10, "111110100": 29, "111110101": 37, "111110110": 44, "111110111": 34, "111111000": 8, "111111001": 13, "111111010": 5, "111111011": 3, "111111100": 35, "111111101": 28, "111111110": 37, "111111111": 38}

raw_zv = {"000000000": 44, "000000001": 39, "000000010": 44, "000000011": 44, "000000100": 13, "000000101": 8, "000000110": 12, "000000111": 12, "000001000": 34, "000001001": 26, "000001010": 41, "000001011": 41, "000001100": 8, "000001101": 8, "000001110": 6, "000001111": 6, "000010000": 10, "000010001": 8, "000010010": 9, "000010011": 8, "000010100": 1, "000010110": 3, "000010111": 1, "000011000": 8, "000011001": 8, "000011010": 9, "000011011": 5, "000011100": 2, "000011101": 1, "000011110": 1, "000011111": 1, "000100000": 19, "000100001": 11, "000100010": 14, "000100011": 11, "000100100": 27, "000100101": 33, "000100110": 39, "000100111": 35, "000101000": 5, "000101001": 6, "000101010": 8, "000101011": 11, "000101100": 30, "000101101": 42, "000101110": 37, "000101111": 32, "000110000": 5, "000110001": 3, "000110010": 1, "000110011": 1, "000110100": 11, "000110101": 3, "000110110": 13, "000110111": 9, "000111000": 4, "000111001": 2, "000111010": 3, "000111011": 3, "000111100": 6, "000111101": 4, "000111110": 11, "000111111": 9, "001000000": 8, "001000001": 11, "001000010": 6, "001000011": 11, "001000100": 2, "001000110": 1, "001000111": 2, "001001000": 2, "001001001": 6, "001001010": 11, "001001011": 11, "001001100": 3, "001001101": 2, "001001110": 2, "001001111": 1, "001010000": 42, "001010001": 36, "001010010": 34, "001010011": 36, "001010100": 6, "001010101": 8, "001010110": 13, "001010111": 6, "001011000": 21, "001011001": 24, "001011010": 38, "001011011": 41, "001011100": 6, "001011101": 9, "001011110": 4, "001011111": 7, "001100000": 2, "001100100": 8, "001100111": 5, "001101000": 2, "001101001": 4, "001101010": 1, "001101011": 1, "001101100": 9, "001101101": 3, "001101110": 4, "001101111": 5, "001110000": 15, "001110001": 5, "001110010": 7, "001110011": 10, "001110100": 46, "001110101": 25, "001110110": 30, "001110111": 31, "001111000": 14, "001111001": 6, "001111010": 11, "001111011": 2, "001111100": 39, "001111101": 30, "001111110": 34, "001111111": 46, "010000000": 10, "010000001": 12, "010000010": 7, "010000011": 9, "010000100": 4, "010000101": 2, "010000110": 1, "010000111": 2, "010001000": 6, "010001001": 8, "010001010": 13, "010001011": 10, "010001100": 1, "010001101": 4, "010001110": 1, "010001111": 4, "010010001": 4, "010010010": 1, "010010101": 1, "010011000": 3, "010011001": 3, "010011010": 4, "010011011": 2, "010011111": 1, "010100000": 3, "010100001": 3, "010100010": 2, "010100011": 2, "010100100": 12, "010100101": 11, "010100110": 5, "010100111": 11, "010101000": 2, "010101001": 3, "010101010": 1, "010101011": 1, "010101100": 13, "010101101": 3, "010101110": 7, "010101111": 7, "010110000": 3, "010110001": 1, "010110010": 2, "010110100": 3, "010110101": 1, "010110110": 3, "010110111": 1, "010111000": 1, "010111010": 1, "010111100": 1, "010111101": 1, "010111110": 1, "010111111": 2, "011000000": 2, "011000001": 1, "011000010": 5, "011000011": 2, "011001001": 1, "011001010": 3, "011001011": 2, "011001110": 1, "011010000": 10, "011010001": 12, "011010010": 4, "011010011": 17, "011010100": 2, "011010101": 2, "011010110": 2, "011010111": 1, "011011000": 8, "011011001": 6, "011011010": 11, "011011011": 8, "011011100": 3, "011011101": 3, "011011110": 3, "011011111": 1, "011100000": 1, "011100011": 1, "011100100": 6, "011100111": 6, "011101001": 1, "011101101": 4, "011101110": 3, "011101111": 3, "011110000": 5, "011110001": 1, "011110010": 5, "011110011": 1, "011110100": 9, "011110110": 19, "011110111": 10, "011111000": 3, "011111010": 1, "011111011": 1, "011111100": 8, "011111101": 7, "011111110": 8, "011111111": 5, "100000000": 8, "100000001": 8, "100000010": 10, "100000011": 12, "100000100": 2, "100000101": 2, "100000110": 2, "100000111": 2, "100001000": 6, "100001001": 13, "100001010": 6, "100001011": 4, "100001101": 4, "100001110": 2, "100001111": 3, "100010000": 2, "100010001": 1, "100010010": 1, "100010011": 1, "100010100": 2, "100011000": 1, "100011001": 2, "100011010": 5, "100011011": 2, "100011111": 1, "100100000": 3, "100100001": 1, "100100010": 2, "100100011": 2, "100100100": 7, "100100110": 5, "100100111": 4, "100101000": 3, "100101001": 1, "100101010": 1, "100101011": 4, "100101100": 15, "100101101": 2, "100101110": 7, "100101111": 4, "100110100": 1, "100110110": 1, "100110111": 5, "100111100": 1, "100111101": 1, "100111110": 2, "100111111": 3, "101000000": 2, "101000010": 1, "101000111": 1, "101001011": 2, "101001111": 1, "101010000": 15, "101010001": 3, "101010010": 11, "101010011": 12, "101010110": 4, "101010111": 1, "101011000": 7, "101011001": 5, "101011010": 2, "101011011": 7, "101011100": 3, "101011111": 1, "101100010": 1, "101100100": 3, "101100110": 1, "101101100": 1, "101101101": 3, "101101111": 1, "101110000": 2, "101110001": 1, "101110011": 2, "101110100": 15, "101110110": 7, "101110111": 9, "101111000": 3, "101111001": 2, "101111010": 2, "101111011": 1, "101111100": 5, "101111101": 8, "101111110": 6, "101111111": 6, "110000000": 44, "110000001": 40, "110000010": 37, "110000011": 41, "110000100": 9, "110000110": 6, "110000111": 3, "110001000": 24, "110001001": 17, "110001010": 23, "110001011": 31, "110001100": 8, "110001101": 9, "110001110": 11, "110001111": 3, "110010000": 11, "110010001": 9, "110010010": 6, "110010011": 9, "110010100": 1, "110010110": 4, "110010111": 3, "110011000": 8, "110011001": 4, "110011010": 10, "110011011": 6, "110011100": 1, "110011101": 2, "110011111": 2, "110100000": 8, "110100001": 10, "110100010": 9, "110100011": 8, "110100100": 46, "110100110": 43, "110100111": 31, "110101000": 12, "110101001": 10, "110101010": 6, "110101011": 11, "110101100": 35, "110101101": 32, "110101110": 32, "110101111": 29, "110110000": 7, "110110001": 4, "110110010": 4, "110110011": 3, "110110100": 3, "110110110": 8, "110110111": 5, "110111001": 4, "110111010": 1, "110111011": 3, "110111100": 8, "110111101": 3, "110111110": 8, "110111111": 6, "111000000": 6, "111000001": 4, "111000010": 10, "111000011": 8, "111000111": 1, "111001000": 5, "111001001": 4, "111001010": 7, "111001011": 3, "111001100": 3, "111001101": 1, "111001110": 4, "111001111": 1, "111010000": 40, "111010001": 36, "111010010": 38, "111010011": 34, "111010100": 9, "111010110": 7, "111010111": 6, "111011000": 25, "111011001": 38, "111011010": 39, "111011011": 21, "111011100": 4, "111011101": 5, "111011110": 4, "111011111": 1, "111100000": 1, "111100001": 1, "111100010": 2, "111100011": 2, "111100100": 10, "111100110": 5, "111100111": 7, "111101001": 1, "111101010": 1, "111101011": 1, "111101100": 9, "111101101": 2, "111101110": 8, "111101111": 5, "111110000": 10, "111110001": 16, "111110010": 12, "111110011": 11, "111110100": 30, "111110110": 34, "111110111": 36, "111111000": 7, "111111001": 9, "111111010": 9, "111111011": 10, "111111100": 24, "111111101": 28, "111111110": 31, "111111111": 23}

raw_xw = {"000000000": 35, "000000001": 36, "000000010": 27, "000000011": 35, "000000100": 6, "000000101": 6, "000000110": 9, "000000111": 8, "000001000": 46, "000001001": 32, "000001010": 35, "000001011": 26, "000001100": 7, "000001101": 8, "000001110": 5, "000001111": 7, "000010000": 9, "000010001": 12, "000010010": 16, "000010011": 13, "000010100": 1, "000010101": 2, "000010110": 2, "000010111": 4, "000011000": 5, "000011001": 8, "000011010": 5, "000011011": 4, "000011100": 1, "000011110": 1, "000011111": 1, "000100000": 6, "000100001": 12, "000100010": 13, "000100011": 8, "000100100": 47, "000100101": 34, "000100110": 43, "000100111": 42, "000101000": 8, "000101001": 10, "000101010": 8, "000101011": 8, "000101100": 35, "000101101": 29, "000101110": 33, "000101111": 34, "000110000": 1, "000110010": 3, "000110011": 3, "000110100": 9, "000110101": 6, "000110110": 8, "000110111": 13, "000111010": 3, "000111011": 4, "000111100": 10, "000111101": 9, "000111110": 5, "000111111": 8, "001000000": 6, "001000001": 12, "001000010": 7, "001000011": 8, "001000100": 4, "001000101": 1, "001000110": 1, "001000111": 1, "001001000": 6, "001001001": 2, "001001010": 8, "001001011": 7, "001001100": 1, "001001101": 1, "001001110": 3, "001001111": 4, "001010000": 34, "001010001": 32, "001010010": 39, "001010011": 34, "001010100": 13, "001010101": 5, "001010110": 13, "001010111": 10, "001011000": 40, "001011001": 40, "001011010": 41, "001011011": 36, "001011100": 8, "001011101": 7, "001011110": 7, "001011111": 7, "001100000": 3, "001100010": 3, "001100011": 3, "001100100": 10, "001100101": 11, "001100110": 7, "001100111": 7, "001101000": 3, "001101001": 1, "001101010": 1, "001101011": 3, "001101100": 6, "001101101": 8, "001101110": 11, "001101111": 10, "001110000": 11, "001110001": 10, "001110010": 7, "001110011": 10, "001110100": 27, "001110101": 31, "001110110": 45, "001110111": 35, "001111000": 12, "001111001": 7, "001111010": 8, "001111011": 3, "001111100": 38, "001111101": 27, "001111110": 34, "001111111": 40, "010000000": 8, "010000001": 9, "010000010": 12, "010000011": 8, "010000100": 3, "010000101": 2, "010000110": 5, "010000111": 5, "010001000": 8, "010001001": 4, "010001010": 7, "010001011": 6, "010001100": 3, "010001101": 1, "010001110": 4, "010010000": 1, "010010001": 1, "010010010": 4, "010010011": 3, "010010100": 1, "010010111": 1, "010011000": 3, "010011001": 2, "010011010": 1, "010011011": 1, "010011100": 2, "010011111": 1, "010100000": 3, "010100001": 1, "010100010": 1, "010100011": 3, "010100100": 11, "010100110": 6, "010100111": 14, "010101000": 2, "010101001": 1, "010101011": 1, "010101100": 10, "010101101": 8, "010101110": 9, "010101111": 5, "010110000": 1, "010110100": 3, "010110110": 4, "010110111": 1, "010111000": 1, "010111010": 1, "010111011": 1, "010111100": 1, "010111110": 3, "010111111": 2, "011000000": 4, "011000001": 4, "011000010": 1, "011000011": 2, "011000110": 1, "011001001": 1, "011001010": 2, "011001011": 2, "011001100": 1, "011001101": 1, "011010000": 9, "011010001": 15, "011010010": 5, "011010011": 7, "011010100": 4, "011010101": 2, "011010110": 1, "011010111": 4, "011011000": 5, "011011001": 10, "011011010": 7, "011011011": 6, "011011100": 5, "011011101": 2, "011011110": 4, "011011111": 1, "011100000": 1, "011100010": 2, "011100100": 2, "011100101": 3, "011100110": 4, "011100111": 1, "011101000": 2, "011101010": 1, "011101100": 1, "011101101": 1, "011101110": 2, "011101111": 1, "011110000": 1, "011110001": 3, "011110010": 3, "011110011": 2, "011110100": 8, "011110110": 10, "011110111": 9, "011111000": 3, "011111001": 3, "011111011": 4, "011111100": 8, "011111101": 13, "011111110": 12, "011111111": 7, "100000000": 8, "100000001": 10, "100000010": 5, "100000011": 4, "100000100": 4, "100000101": 1, "100000111": 1, "100001000": 7, "100001001": 3, "100001010": 6, "100001011": 5, "100001100": 3, "100001101": 2, "100001111": 2, "100010000": 3, "100010001": 2, "100010011": 3, "100010111": 1, "100011000": 1, "100011001": 1, "100011010": 2, "100011011": 2, "100011100": 1, "100011101": 1, "100011110": 1, "100011111": 1, "100100000": 1, "100100010": 3, "100100011": 1, "100100100": 11, "100100110": 7, "100100111": 7, "100101001": 1, "100101010": 4, "100101011": 4, "100101100": 7, "100101101": 10, "100101110": 6, "100101111": 8, "100110000": 1, "100110100": 1, "100110110": 2, "100111000": 2, "100111010": 1, "100111100": 2, "100111101": 1, "100111110": 2, "100111111": 2, "101000000": 2, "101000001": 2, "101000011": 1, "101000110": 2, "101000111": 1, "101001000": 1, "101001001": 1, "101001011": 1, "101001101": 1, "101010000": 5, "101010001": 9, "101010010": 11, "101010011": 3, "101010100": 3, "101010101": 1, "101010110": 2, "101010111": 2, "101011000": 10, "101011001": 9, "101011010": 9, "101011011": 5, "101011100": 2, "101011101": 2, "101011110": 1, "101011111": 2, "101100001": 2, "101100100": 2, "101100110": 1, "101100111": 4, "101101100": 1, "101101101": 2, "101101110": 2, "101101111": 2, "101110000": 1, "101110001": 1, "101110010": 2, "101110011": 2, "101110100": 10, "101110110": 7, "101110111": 6, "101111000": 1, "101111001": 1, "101111010": 3, "101111100": 6, "101111101": 6, "101111110": 10, "101111111": 10, "110000000": 35, "110000001": 35, "110000010": 34, "110000011": 31, "110000100": 5, "110000101": 11, "110000110": 4, "110000111": 5, "110001000": 31, "110001001": 28, "110001010": 27, "110001011": 33, "110001100": 6, "110001101": 6, "110001110": 6, "110001111": 6, "110010000": 8, "110010001": 10, "110010010": 3, "110010011": 8, "110010100": 4, "110010101": 2, "110010110": 3, "110010111": 2, "110011000": 4, "110011001": 6, "110011010": 10, "110011011": 10, "110011100": 1, "110011101": 2, "110011111": 2, "110100000": 8, "110100001": 6, "110100010": 6, "110100011": 4, "110100100": 35, "110100101": 30, "110100110": 36, "110100111": 26, "110101000": 9, "110101001": 10, "110101010": 9, "110101011": 9, "110101100": 28, "110101101": 33, "110101110": 31, "110101111": 27, "110110000": 3, "110110001": 3, "110110010": 2, "110110011": 4, "110110100": 10, "110110101": 6, "110110110": 7, "110110111": 8, "110111000": 2, "110111010": 1, "110111011": 2, "110111100": 8, "110111101": 4, "110111110": 8, "110111111": 8, "111000000": 7, "111000001": 9, "111000010": 11, "111000011": 8, "111000100": 5, "111000101": 2, "111000110": 2, "111000111": 1, "111001000": 3, "111001001": 5, "111001010": 10, "111001011": 5, "111001100": 1, "111001101": 2, "111001110": 1, "111001111": 1, "111010000": 28, "111010001": 40, "111010010": 35, "111010011": 45, "111010100": 11, "111010101": 7, "111010110": 8, "111010111": 9, "111011000": 31, "111011001": 31, "111011010": 36, "111011011": 32, "111011100": 7, "111011101": 4, "111011110": 6, "111011111": 7, "111100000": 2, "111100100": 8, "111100110": 7, "111100111": 6, "111101001": 1, "111101010": 1, "111101011": 3, "111101100": 5, "111101101": 10, "111101110": 7, "111101111": 6, "111110000": 9, "111110001": 6, "111110010": 10, "111110011": 8, "111110100": 31, "111110110": 49, "111110111": 42, "111111000": 6, "111111001": 7, "111111010": 5, "111111011": 6, "111111100": 38, "111111101": 26, "111111110": 31, "111111111": 24}

raw_xv = {"000000011": 1, "000000100": 1, "000000101": 3, "000000110": 2, "000000111": 3, "000001000": 1, "000001010": 1, "000001100": 3, "000001101": 1, "000001110": 3, "000001111": 2, "000010000": 1, "000010001": 3, "000010010": 2, "000010011": 3, "000010100": 7, "000010101": 9, "000010110": 7, "000010111": 10, "000011000": 3, "000011001": 3, "000011010": 3, "000011011": 3, "000011100": 9, "000011101": 13, "000011110": 17, "000011111": 13, "000100000": 3, "000100010": 1, "000100011": 4, "000101001": 1, "000101011": 1, "000101110": 1, "000110000": 9, "000110001": 6, "000110010": 6, "000110011": 13, "000110100": 2, "000110101": 2, "000110111": 3, "000111000": 11, "000111001": 10, "000111010": 9, "000111011": 13, "000111100": 4, "000111101": 2, "000111111": 3, "001000000": 1, "001000001": 4, "001000010": 6, "001000011": 1, "001000100": 13, "001000101": 8, "001000110": 14, "001000111": 13, "001001000": 3, "001001001": 3, "001001010": 6, "001001011": 1, "001001100": 8, "001001101": 11, "001001110": 5, "001001111": 5, "001010000": 1, "001010100": 1, "001010101": 2, "001010110": 1, "001010111": 4, "001011001": 1, "001011011": 1, "001011100": 1, "001011101": 2, "001011110": 2, "001011111": 3, "001100000": 8, "001100001": 8, "001100010": 13, "001100011": 11, "001100100": 4, "001100101": 5, "001100110": 1, "001100111": 3, "001101000": 11, "001101001": 7, "001101010": 12, "001101011": 7, "001101101": 1, "001110000": 1, "001110001": 1, "001110010": 5, "001110111": 1, "001111000": 1, "001111001": 4, "001111010": 3, "001111011": 3, "001111111": 1, "010000000": 3, "010000001": 2, "010000010": 2, "010000011": 4, "010000100": 13, "010000101": 8, "010000110": 4, "010000111": 8, "010001000": 5, "010001001": 2, "010001011": 1, "010001100": 9, "010001101": 6, "010001110": 5, "010001111": 11, "010010000": 4, "010010001": 4, "010010010": 9, "010010011": 5, "010010100": 46, "010010101": 44, "010010110": 36, "010010111": 42, "010011000": 7, "010011001": 7, "010011010": 8, "010011011": 7, "010011100": 38, "010011101": 39, "010011110": 46, "010011111": 35, "010100000": 12, "010100001": 6, "010100010": 9, "010100011": 8, "010100100": 2, "010100101": 1, "010100110": 1, "010100111": 1, "010101000": 9, "010101001": 3, "010101010": 8, "010101011": 3, "010101100": 2, "010101101": 3, "010101110": 2, "010101111": 1, "010110000": 38, "010110001": 49, "010110010": 36, "010110011": 33, "010110100": 2, "010110101": 13, "010110110": 2, "010110111": 10, "010111000": 37, "010111001": 44, "010111010": 38, "010111011": 29, "010111100": 6, "010111101": 4, "010111110": 7, "010111111": 4, "011000000": 8, "011000001": 7, "011000010": 3, "011000011": 4, "011000100": 40, "011000101": 28, "011000110": 37, "011000111": 33, "011001000": 3, "011001001": 5, "011001010": 14, "011001011": 11, "011001100": 41, "011001101": 44, "011001110": 24, "011001111": 29, "011010001": 1, "011010010": 2, "011010100": 10, "011010101": 5, "011010110": 5, "011010111": 12, "011011000": 1, "011011001": 1, "011011010": 2, "011011011": 1, "011011100": 7, "011011101": 4, "011011110": 9, "011011111": 7, "011100000": 40, "011100001": 42, "011100010": 52, "011100011": 44, "011100100": 8, "011100101": 6, "011100110": 10, "011100111": 11, "011101000": 32, "011101001": 28, "011101010": 38, "011101011": 33, "011101100": 5, "011101101": 9, "011101110": 4, "011101111": 8, "011110000": 8, "011110001": 11, "011110010": 7, "011110011": 1, "011110100": 1, "011110101": 1, "011110110": 2, "011111000": 6, "011111001": 10, "011111010": 2, "011111011": 4, "011111110": 1, "011111111": 2, "100000000": 1, "100000001": 3, "100000010": 1, "100000011": 4, "100000100": 8, "100000101": 4, "100000110": 4, "100000111": 8, "100001000": 2, "100001001": 2, "100001010": 3, "100001011": 2, "100001100": 1, "100001101": 4, "100001110": 6, "100001111": 12, "100010000": 12, "100010001": 6, "100010010": 8, "100010011": 7, "100010100": 35, "100010101": 21, "100010110": 41, "100010111": 40, "100011000": 7, "100011001": 3, "100011010": 8, "100011011": 6, "100011100": 38, "100011101": 31, "100011110": 38, "100011111": 18, "100100000": 10, "100100001": 8, "100100010": 11, "100100011": 8, "100100100": 1, "100100110": 1, "100100111": 1, "100101000": 6, "100101001": 6, "100101010": 10, "100101011": 11, "100101101": 1, "100101110": 2, "100101111": 2, "100110000": 29, "100110001": 31, "100110010": 30, "100110011": 28, "100110100": 11, "100110101": 6, "100110110": 3, "100110111": 7, "100111000": 34, "100111001": 33, "100111010": 41, "100111011": 27, "100111100": 3, "100111101": 6, "100111110": 12, "100111111": 7, "101000000": 11, "101000001": 11, "101000010": 8, "101000011": 6, "101000100": 38, "101000101": 41, "101000110": 45, "101000111": 46, "101001000": 5, "101001001": 3, "101001010": 5, "101001011": 7, "101001100": 37, "101001101": 34, "101001110": 30, "101001111": 31, "101010001": 1, "101010010": 1, "101010011": 1, "101010100": 6, "101010101": 5, "101010110": 11, "101010111": 5, "101011000": 1, "101011001": 2, "101011010": 1, "101011011": 2, "101011100": 7, "101011101": 2, "101011110": 5, "101011111": 9, "101100000": 31, "101100001": 41, "101100010": 31, "101100011": 44, "101100100": 5, "101100101": 7, "101100110": 11, "101100111": 10, "101101000": 32, "101101001": 31, "101101010": 28, "101101011": 45, "101101100": 3, "101101101": 8, "101101110": 4, "101101111": 5, "101110000": 11, "101110001": 7, "101110010": 11, "101110011": 7, "101110100": 3, "101111000": 3, "101111001": 12, "101111010": 8, "101111011": 5, "101111100": 2, "101111101": 1, "101111110": 1, "101111111": 1, "110000100": 1, "110000110": 1, "110000111": 2, "110001100": 2, "110001111": 3, "110010010": 2, "110010011": 1, "110010100": 8, "110010101": 5, "110010110": 13, "110010111": 6, "110011000": 2, "110011001": 1, "110011011": 3, "110011100": 6, "110011101": 6, "110011110": 7, "110011111": 7, "110100000": 3, "110100001": 1, "110100011": 1, "110100110": 1, "110101001": 1, "110101010": 1, "110101011": 1, "110110000": 3, "110110001": 9, "110110010": 12, "110110011": 9, "110110101": 1, "110110110": 4, "110110111": 2, "110111000": 6, "110111001": 5, "110111010": 8, "110111011": 7, "110111100": 1, "110111101": 3, "110111110": 2, "110111111": 1, "111000000": 1, "111000001": 3, "111000010": 1, "111000011": 5, "111000100": 9, "111000110": 12, "111000111": 2, "111001000": 1, "111001001": 3, "111001010": 2, "111001011": 1, "111001100": 6, "111001101": 3, "111001110": 8, "111001111": 3, "111010011": 1, "111010100": 1, "111010110": 1, "111011011": 3, "111011100": 2, "111011110": 1, "111011111": 4, "111100000": 10, "111100001": 7, "111100010": 3, "111100011": 7, "111100100": 1, "111100110": 3, "111100111": 1, "111101000": 7, "111101001": 4, "111101010": 9, "111101011": 12, "111101100": 1, "111101101": 2, "111101110": 4, "111101111": 4, "111110000": 1, "111110001": 5, "111110010": 2, "111110011": 1, "111110110": 1, "111111000": 2, "111111001": 1, "111111010": 1, "111111011": 2, "111111110": 1}


def is_valid_bitstring(key, n=9):
    """Check that key is exactly n characters of 0/1."""
    return len(key) == n and all(c in '01' for c in key)


def filter_histogram(raw):
    """Filter to valid 9-bit bitstrings only."""
    filtered = {}
    skipped = 0
    for key, count in raw.items():
        if is_valid_bitstring(key):
            filtered[key] = count
        else:
            skipped += count
    return filtered, skipped


def decode_poem_indices(s):
    """
    Given a 9-bit MSB-first bitstring, decode first/middle/last line indices.
    
    s[0]=q8, s[1]=q7, s[2]=q6, s[3]=q5, s[4]=q4, s[5]=q3, s[6]=q2, s[7]=q1, s[8]=q0
    
    Alice (first line): q7, q4, q2 -> s[1], s[4], s[6] -> 3-bit index 0-7
    Middle (free): q3, q1, q0 -> s[5], s[7], s[8] -> 3-bit index 0-7
    Bob (last line): q8, q6, q5 -> s[0], s[2], s[3] -> 3-bit index 0-7
    """
    first_idx = int(s[1]) * 4 + int(s[4]) * 2 + int(s[6])
    middle_idx = int(s[5]) * 4 + int(s[7]) * 2 + int(s[8])
    last_idx = int(s[0]) * 4 + int(s[2]) * 2 + int(s[3])
    return first_idx, middle_idx, last_idx


def get_bell_bits(s):
    """
    Extract alice/bob bits for each Bell pair.
    Returns list of (alice_bit, bob_bit) for 3 pairs.
    
    Pair 0 (edge 2-5): alice=s[6], bob=s[3]
    Pair 1 (edge 4-6): alice=s[4], bob=s[2]
    Pair 2 (edge 7-8): alice=s[1], bob=s[0]
    """
    return [
        (int(s[6]), int(s[3])),  # pair 0: edge 2-5
        (int(s[4]), int(s[2])),  # pair 1: edge 4-6
        (int(s[1]), int(s[0])),  # pair 2: edge 7-8
    ]


def compute_E(histogram, pair_idx):
    """
    Compute E(A,B) = (N_same - N_diff) / N_total for a given Bell pair.
    same = alice_bit == bob_bit, diff = alice_bit != bob_bit
    """
    n_same = 0
    n_diff = 0
    for bitstring, count in histogram.items():
        bells = get_bell_bits(bitstring)
        a, b = bells[pair_idx]
        if a == b:
            n_same += count
        else:
            n_diff += count
    n_total = n_same + n_diff
    if n_total == 0:
        return 0.0, 0
    return (n_same - n_diff) / n_total, n_total


def compute_E_stderr(E, n_total):
    """Standard error of E = (N+ - N-)/N from binomial statistics."""
    # Var(E) = (1 - E^2) / N
    if n_total == 0:
        return 0.0
    return math.sqrt(max(0, (1 - E**2) / n_total))


def main():
    # ── Filter histograms ──────────────────────────────────────────────────
    datasets = {
        'ZZ': raw_zz,
        'ZW': raw_zw,
        'ZV': raw_zv,
        'XW': raw_xw,
        'XV': raw_xv,
    }
    
    histograms = {}
    for name, raw in datasets.items():
        h, skipped = filter_histogram(raw)
        total = sum(h.values())
        histograms[name] = h
        print(f"Job {name}: {total} valid shots, {skipped} skipped (invalid keys)")
    
    print()
    
    # ── 1. ZZ Poem Distribution ────────────────────────────────────────────
    print("=" * 60)
    print("ZZ CIRCUIT: POEM DISTRIBUTION")
    print("=" * 60)
    
    zz = histograms['ZZ']
    total_zz = sum(zz.values())
    
    # 8x8 first x last matrix (marginalize over middle)
    matrix = np.zeros((8, 8), dtype=int)
    # Also track the full (first, middle, last) distribution
    poem_dist = {}
    
    for bitstring, count in zz.items():
        first_idx, middle_idx, last_idx = decode_poem_indices(bitstring)
        matrix[first_idx][last_idx] += count
        key = f"{first_idx}-{middle_idx}-{last_idx}"
        poem_dist[key] = poem_dist.get(key, 0) + count
    
    print(f"\nTotal shots: {total_zz}")
    
    # First x Last correlation matrix
    print("\nFirst x Last correlation matrix (rows=first, cols=last):")
    print("       ", "  ".join(f"  L{j}" for j in range(8)))
    for i in range(8):
        row_str = "  ".join(f"{matrix[i][j]:4d}" for j in range(8))
        print(f"  F{i}:  {row_str}")
    
    # Correlation rate (first == last)
    diagonal_counts = sum(matrix[i][i] for i in range(8))
    correlation_rate = diagonal_counts / total_zz
    print(f"\nFirst/Last correlation rate: {diagonal_counts}/{total_zz} = {correlation_rate:.4f} ({correlation_rate*100:.1f}%)")
    
    # Expected if uniform and independent: 8/64 = 12.5%
    # Expected if perfectly entangled: 100%
    print(f"Expected if uniform/independent: 12.5%")
    print(f"Expected if perfectly entangled: 100.0%")
    
    # Show which (first, last) pairs dominate
    print("\nTop 10 (first, last) pairs:")
    fl_pairs = []
    for i in range(8):
        for j in range(8):
            if matrix[i][j] > 0:
                fl_pairs.append((i, j, matrix[i][j]))
    fl_pairs.sort(key=lambda x: -x[2])
    for i, j, c in fl_pairs[:10]:
        pct = c / total_zz * 100
        match = " [MATCHED]" if i == j else ""
        print(f"  first={i}, last={j}: {c} ({pct:.1f}%){match}")
    
    # ── 2. CHSH Bell Inequality ────────────────────────────────────────────
    print("\n" + "=" * 60)
    print("CHSH BELL INEQUALITY TEST")
    print("=" * 60)
    
    # Basis labels
    basis_labels = {
        'ZW': 'A0B0',
        'ZV': 'A0B1',
        'XW': 'A1B0',
        'XV': 'A1B1',
    }
    
    pair_names = [
        "Pair 0 (q2-q5)",
        "Pair 1 (q4-q6)",
        "Pair 2 (q7-q8)",
    ]
    
    # Compute E for each basis and each pair
    E_values = {}  # E_values[basis][pair_idx] = (E, n, stderr)
    
    for basis in ['ZW', 'ZV', 'XW', 'XV']:
        E_values[basis] = []
        print(f"\n{basis} ({basis_labels[basis]}):")
        for pair_idx in range(3):
            E, n = compute_E(histograms[basis], pair_idx)
            se = compute_E_stderr(E, n)
            E_values[basis].append((E, n, se))
            print(f"  {pair_names[pair_idx]}: E = {E:+.4f} +/- {se:.4f}  (N={n})")
    
    # Compute S for each pair
    print("\n" + "-" * 40)
    print("CHSH S VALUES (per pair)")
    print("S = E(A0B0) + E(A0B1) + E(A1B0) - E(A1B1)")
    print("-" * 40)
    
    S_values = []
    S_errors = []
    
    for pair_idx in range(3):
        E_zw = E_values['ZW'][pair_idx]
        E_zv = E_values['ZV'][pair_idx]
        E_xw = E_values['XW'][pair_idx]
        E_xv = E_values['XV'][pair_idx]
        
        S = E_zw[0] + E_zv[0] + E_xw[0] - E_xv[0]
        # Error propagation (independent): sigma_S = sqrt(sum of sigma_Ei^2)
        S_err = math.sqrt(E_zw[2]**2 + E_zv[2]**2 + E_xw[2]**2 + E_xv[2]**2)
        
        S_values.append(S)
        S_errors.append(S_err)
        
        violation = "|S| > 2" if abs(S) > 2 else "|S| <= 2"
        sigma_from_2 = (abs(S) - 2) / S_err if S_err > 0 else 0
        print(f"\n{pair_names[pair_idx]}:")
        print(f"  S = {S:+.4f} +/- {S_err:.4f}")
        print(f"  |S| = {abs(S):.4f}  ({violation})")
        if abs(S) > 2:
            print(f"  Violation: {sigma_from_2:.1f} sigma above classical bound")
        else:
            print(f"  Below classical bound by {sigma_from_2:.1f} sigma")
    
    # Average S across pairs
    S_avg = np.mean(S_values)
    S_avg_err = np.sqrt(np.sum(np.array(S_errors)**2)) / 3  # error of the mean
    
    print("\n" + "-" * 40)
    print("AVERAGE ACROSS 3 BELL PAIRS")
    print("-" * 40)
    print(f"S_avg = {S_avg:+.4f} +/- {S_avg_err:.4f}")
    print(f"|S_avg| = {abs(S_avg):.4f}")
    
    bell_violation = abs(S_avg) > 2
    if bell_violation:
        sigma_violation = (abs(S_avg) - 2) / S_avg_err
        print(f"BELL VIOLATION: {sigma_violation:.1f} sigma above classical bound")
    else:
        sigma_gap = (2 - abs(S_avg)) / S_avg_err
        print(f"No Bell violation ({sigma_gap:.1f} sigma below classical bound)")
    
    # Theoretical maximum for Bell states: 2*sqrt(2) ~ 2.828
    print(f"\nTheoretical max (pure Bell states): 2*sqrt(2) = {2*math.sqrt(2):.4f}")
    if abs(S_avg) > 0:
        efficiency = abs(S_avg) / (2 * math.sqrt(2)) * 100
        print(f"Achieved: {efficiency:.1f}% of theoretical maximum")
    
    # ── ZZ Bell pair correlations (sanity check) ───────────────────────────
    print("\n" + "-" * 40)
    print("ZZ BELL PAIR CORRELATIONS (sanity check)")
    print("-" * 40)
    for pair_idx in range(3):
        E, n = compute_E(histograms['ZZ'], pair_idx)
        se = compute_E_stderr(E, n)
        print(f"  {pair_names[pair_idx]}: E_ZZ = {E:+.4f} +/- {se:.4f}  (N={n})")
    
    # ── 3. Save JSON ───────────────────────────────────────────────────────
    
    # Build the first x last distribution as a dict for frontend
    first_last_dist = {}
    for i in range(8):
        for j in range(8):
            if matrix[i][j] > 0:
                first_last_dist[f"{i},{j}"] = int(matrix[i][j])
    
    # E-values as nested dict
    e_results = {}
    for basis in ['ZW', 'ZV', 'XW', 'XV']:
        e_results[basis] = {
            'label': basis_labels[basis],
            'pairs': []
        }
        for pair_idx in range(3):
            E, n, se = E_values[basis][pair_idx]
            e_results[basis]['pairs'].append({
                'pair': pair_names[pair_idx],
                'E': round(E, 6),
                'N': n,
                'stderr': round(se, 6),
            })
    
    results = {
        'experiment': 'quantum-poetry-bell-test',
        'platform': 'Quantum Inspire Tuna-9',
        'date': '2026-02-14',
        'jobs': {
            'ZZ': 426263,
            'ZW': 426264,
            'ZV': 426265,
            'XW': 426266,
            'XV': 426267,
        },
        'qubit_assignment': {
            'alice_first_line': ['q7', 'q4', 'q2'],
            'bob_last_line': ['q8', 'q6', 'q5'],
            'middle_free': ['q3', 'q1', 'q0'],
            'bell_pairs': [
                {'edge': '2-5', 'alice_bit': 's[6]', 'bob_bit': 's[3]'},
                {'edge': '4-6', 'alice_bit': 's[4]', 'bob_bit': 's[2]'},
                {'edge': '7-8', 'alice_bit': 's[1]', 'bob_bit': 's[0]'},
            ]
        },
        'poem_distribution': {
            'total_shots': total_zz,
            'first_last_matrix': matrix.tolist(),
            'first_last_correlation_rate': round(correlation_rate, 6),
            'diagonal_counts': int(diagonal_counts),
            'first_last_dist': first_last_dist,
            'full_dist': poem_dist,
        },
        'chsh': {
            'formula': 'S = E(A0B0) + E(A0B1) + E(A1B0) - E(A1B1)',
            'basis_mapping': {
                'A0B0': 'ZW (job 426264)',
                'A0B1': 'ZV (job 426265)',
                'A1B0': 'XW (job 426266)',
                'A1B1': 'XV (job 426267)',
            },
            'E_values': e_results,
            'S_per_pair': [
                {
                    'pair': pair_names[i],
                    'S': round(S_values[i], 6),
                    'stderr': round(S_errors[i], 6),
                    'abs_S': round(abs(S_values[i]), 6),
                    'violates_classical': abs(S_values[i]) > 2,
                }
                for i in range(3)
            ],
            'S_average': round(float(S_avg), 6),
            'S_average_stderr': round(float(S_avg_err), 6),
            'bell_violation': bool(bell_violation),
            'classical_bound': 2.0,
            'quantum_bound': round(2 * math.sqrt(2), 6),
            'sigma_from_classical': round(float((abs(S_avg) - 2) / S_avg_err), 2) if S_avg_err > 0 else None,
        },
    }
    
    outpath = '/Users/dereklomas/haiqu/experiments/results/quantum-poetry-bell-test.json'
    with open(outpath, 'w') as f:
        json.dump(results, f, indent=2)
    
    print(f"\nResults saved to {outpath}")


if __name__ == '__main__':
    main()
