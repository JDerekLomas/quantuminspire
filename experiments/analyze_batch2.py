"""Analyze batch 2 hardware results from Tuna-9.

Processes:
1. QV=16 circuits c2-c9 (full HOF analysis with c0-c1)
2. VQE REM runs 005-008 (statistical analysis with run 004)
3. QAOA MaxCut on 4-cycle subgraphs
"""
import json
import math
import numpy as np

# ============================================================
# 1. QV=16 — ALL 10 CIRCUITS
# ============================================================

# Ideal distributions from emulator
qv_ideal = {
    "qv16_c0": {"0000": 0.047344652022662415, "0001": 0.35800329630033684, "0010": 0.05461385504104445, "0011": 0.07680900350632, "0100": 0.028472868271083352, "0101": 0.2153016288153065, "0110": 0.032844535421136085, "0111": 0.04619260139079256, "1000": 0.009782064904175774, "1001": 0.07396847015883572, "1010": 0.011283983551574566, "1011": 0.015869810536662893, "1100": 0.0026031475451367414, "1101": 0.01968406909969466, "1110": 0.003002829603911706, "1111": 0.0042231838313262745},
    "qv16_c1": {"0000": 0.013753283301775412, "0001": 0.06747977669781358, "0010": 0.13010857833089595, "0011": 0.13473326050012466, "0100": 0.05703910665992843, "0101": 0.0020579651782805393, "0110": 0.026176321821084647, "0111": 0.09086717227093101, "1000": 0.0023838762000456684, "1001": 0.0057599157593149625, "1010": 0.12600442642589538, "1011": 0.03514723473906647, "1100": 0.11051647669023272, "1101": 0.02968474825069336, "1110": 0.14668801197235454, "1111": 0.02159984520156237},
    "qv16_c2": {"0000": 0.039490068171277634, "0001": 0.04955836400584509, "0010": 0.012332671807924054, "0011": 0.022278859494234478, "0100": 0.06326981688264399, "0101": 0.1166061863669759, "0110": 0.0037617006142044657, "0111": 0.07891683836599431, "1000": 0.037554022216695244, "1001": 6.825311180329789e-05, "1010": 0.1361354437652155, "1011": 0.08004641074126453, "1100": 0.0009225776892199417, "1101": 0.0371215529632224, "1110": 0.1197565328555749, "1111": 0.20218070094790386},
    "qv16_c3": {"0000": 0.007210457210983339, "0001": 0.014463400221124113, "0010": 0.016059171149557926, "0011": 0.001409445143061406, "0100": 0.11495778828966735, "0101": 0.23059293633086567, "0110": 0.2560346373467548, "0111": 0.022471071059841388, "1000": 0.032740793841022235, "1001": 0.06567450454579969, "1010": 0.07292048152847456, "1011": 0.006399920491714565, "1100": 0.02930152593050626, "1101": 0.0587757037066949, "1110": 0.06526052455375937, "1111": 0.0057276386501720405},
    "qv16_c4": {"0000": 0.06583163429982727, "0001": 0.02903352033437198, "0010": 0.06149423569238494, "0011": 0.03691414888113802, "0100": 0.27873387492254514, "0101": 0.07823231122190251, "0110": 0.026629531821862618, "0111": 0.027545975219381638, "1000": 0.010033925272375278, "1001": 0.02163645354449244, "1010": 0.00028432629699003586, "1011": 0.10704063454138582, "1100": 0.09266185820895828, "1101": 0.09572008631720429, "1110": 0.0018923563640147057, "1111": 0.06631512706116562},
    "qv16_c5": {"0000": 0.001916731077648771, "0001": 0.004751934739049897, "0010": 0.002402440685322142, "0011": 0.01243082182836179, "0100": 0.04250138264234464, "0101": 0.0631314645380637, "0110": 0.010382377252707962, "0111": 0.13113841915861124, "1000": 0.10006960046649482, "1001": 0.020823467746543818, "1010": 0.002641341139840271, "1011": 0.05816320603430452, "1100": 0.17583323990615796, "1101": 0.13066577565862358, "1110": 0.09428579715112496, "1111": 0.1488619999747995},
    "qv16_c6": {"0000": 0.05885445838269805, "0001": 0.005832043717942778, "0010": 0.20057214190653522, "0011": 0.07171601191295465, "0100": 0.04231930121699824, "0101": 0.2158815824193389, "0110": 0.022771277106239125, "0111": 0.048752703360401585, "1000": 0.022838408788208843, "1001": 0.04706036562433688, "1010": 0.06549117443238887, "1011": 0.006175208844282919, "1100": 0.043647056483960875, "1101": 0.09294149869585454, "1110": 0.002521751308486907, "1111": 0.05262501579937155},
    "qv16_c7": {"0000": 0.0610230330755353, "0001": 0.07824323697782282, "0010": 0.13842901658619258, "0011": 0.18111064151885817, "0100": 0.07951673185307881, "0101": 0.03231433889869767, "0110": 0.16253511317900857, "0111": 0.0613138998981078, "1000": 0.006864608924853974, "1001": 0.023671131324097636, "1010": 0.0361408527247452, "1011": 0.03074594408803947, "1100": 0.007172527257273683, "1101": 0.05943659585600737, "1110": 0.03174248524865132, "1111": 0.009739842589029522},
    "qv16_c8": {"0000": 0.05584729270047209, "0001": 0.02038357091053128, "0010": 0.010177570505927097, "0011": 0.0011455555543140577, "0100": 0.04175198792422033, "0101": 0.05429602188017716, "0110": 0.006758182940306777, "0111": 0.006611900605311133, "1000": 0.008437494080627037, "1001": 0.010436753763487053, "1010": 0.25977376927733686, "1011": 0.01252488726697397, "1100": 0.05242804410733485, "1101": 0.024061255577442056, "1110": 0.16934506790879145, "1111": 0.2660206449967453},
    "qv16_c9": {"0000": 0.04868918469475695, "0001": 0.03210456240431694, "0010": 0.014068697071814051, "0011": 0.041246895152920085, "0100": 0.006337638412180107, "0101": 0.0041788974117231755, "0110": 0.0018312550421748055, "0111": 0.005368911160520214, "1000": 0.06080618528523893, "1001": 0.040094242331164556, "1010": 0.017569893729659166, "1011": 0.05151177545553278, "1100": 0.24188810712160963, "1101": 0.15949562266513095, "1110": 0.06989335569496384, "1111": 0.20491477636629454},
}

# Heavy output sets from emulator
qv_heavy = {
    "qv16_c0": ["0000", "0001", "0010", "0011", "0101", "0110", "0111", "1001"],
    "qv16_c1": ["0001", "0010", "0011", "0100", "0111", "1010", "1100", "1110"],
    "qv16_c2": ["0001", "0100", "0101", "0111", "1010", "1011", "1110", "1111"],
    "qv16_c3": ["0100", "0101", "0110", "1000", "1001", "1010", "1101", "1110"],
    "qv16_c4": ["0000", "0010", "0100", "0101", "1011", "1100", "1101", "1111"],
    "qv16_c5": ["0101", "0111", "1000", "1011", "1100", "1101", "1110", "1111"],
    "qv16_c6": ["0000", "0010", "0011", "0101", "0111", "1010", "1101", "1111"],
    "qv16_c7": ["0000", "0001", "0010", "0011", "0100", "0110", "0111", "1101"],
    "qv16_c8": ["0000", "0100", "0101", "1010", "1100", "1101", "1110", "1111"],
    "qv16_c9": ["0000", "0011", "1000", "1011", "1100", "1101", "1110", "1111"],
}

# Hardware results — 4-bit bitstrings from measurement of q4,q6,q7,q8
qv_hw_counts = {
    "qv16_c0": {"job_id": 425239, "counts": {"0000": 265, "0001": 927, "0010": 163, "0011": 168, "0100": 175, "0101": 653, "0110": 133, "0111": 112, "1000": 164, "1001": 593, "1010": 126, "1011": 113, "1100": 83, "1101": 324, "1110": 49, "1111": 48}},
    "qv16_c1": {"job_id": 425241, "counts": {"0000": 179, "0001": 222, "0010": 560, "0011": 390, "0100": 266, "0101": 89, "0110": 220, "0111": 301, "1000": 110, "1001": 58, "1010": 279, "1011": 208, "1100": 434, "1101": 244, "1110": 266, "1111": 270}},
    "qv16_c2": {"job_id": 425252, "counts": {"0000": 306, "0001": 291, "0010": 179, "0011": 142, "0100": 267, "0101": 239, "0110": 153, "0111": 297, "1000": 243, "1001": 108, "1010": 546, "1011": 336, "1100": 82, "1101": 129, "1110": 355, "1111": 423}},
    "qv16_c3": {"job_id": 425254, "counts": {"0000": 186, "0001": 127, "0010": 145, "0011": 65, "0100": 528, "0101": 407, "0110": 527, "0111": 192, "1000": 302, "1001": 207, "1010": 250, "1011": 107, "1100": 312, "1101": 259, "1110": 361, "1111": 121}},
    "qv16_c4": {"job_id": 425256, "counts": {"0000": 349, "0001": 154, "0010": 250, "0011": 243, "0100": 705, "0101": 241, "0110": 96, "0111": 237, "1000": 127, "1001": 153, "1010": 57, "1011": 301, "1100": 427, "1101": 359, "1110": 134, "1111": 263}},
    "qv16_c5": {"job_id": 425258, "counts": {"0000": 108, "0001": 78, "0010": 110, "0011": 166, "0100": 240, "0101": 165, "0110": 341, "0111": 312, "1000": 215, "1001": 156, "1010": 174, "1011": 183, "1100": 524, "1101": 283, "1110": 651, "1111": 390}},
    "qv16_c6": {"job_id": 425260, "counts": {"0000": 137, "0001": 147, "0010": 681, "0011": 302, "0100": 169, "0101": 450, "0110": 183, "0111": 219, "1000": 182, "1001": 337, "1010": 455, "1011": 68, "1100": 167, "1101": 354, "1110": 81, "1111": 164}},
    "qv16_c7": {"job_id": 425262, "counts": {"0000": 148, "0001": 215, "0010": 1027, "0011": 712, "0100": 222, "0101": 64, "0110": 409, "0111": 326, "1000": 120, "1001": 74, "1010": 163, "1011": 70, "1100": 81, "1101": 111, "1110": 305, "1111": 49}},
    "qv16_c8": {"job_id": 425264, "counts": {"0000": 188, "0001": 65, "0010": 144, "0011": 59, "0100": 40, "0101": 140, "0110": 103, "0111": 105, "1000": 349, "1001": 66, "1010": 1311, "1011": 235, "1100": 55, "1101": 187, "1110": 309, "1111": 740}},
    "qv16_c9": {"job_id": 425266, "counts": {"0000": 126, "0001": 86, "0010": 67, "0011": 116, "0100": 149, "0101": 95, "0110": 66, "0111": 145, "1000": 310, "1001": 188, "1010": 132, "1011": 283, "1100": 760, "1101": 495, "1110": 346, "1111": 732}},
}

print("=" * 70)
print("  QV=16 — Tuna-9 Hardware Results (all 10 circuits)")
print("=" * 70)

qv_results = []
for i in range(10):
    name = f"qv16_c{i}"
    hw = qv_hw_counts[name]
    counts = hw["counts"]
    total = sum(counts.values())
    heavy = set(qv_heavy[name])

    heavy_count = sum(counts.get(bs, 0) for bs in heavy)
    hof = heavy_count / total
    passed = hof > 2/3

    qv_results.append({
        "circuit": name,
        "job_id": hw["job_id"],
        "heavy_count": heavy_count,
        "total": total,
        "hof": round(hof, 4),
        "pass": passed,
    })

    print(f"\n  {name} (job {hw['job_id']}):")
    print(f"    Heavy count: {heavy_count}/{total}")
    print(f"    HOF = {hof:.4f}  {'PASS' if passed else 'FAIL'}")

# Summary
n_pass = sum(1 for r in qv_results if r["pass"])
mean_hof = np.mean([r["hof"] for r in qv_results])
std_hof = np.std([r["hof"] for r in qv_results], ddof=1)

print(f"\n  --- QV=16 Summary ---")
print(f"  Circuits passed: {n_pass}/10")
print(f"  Mean HOF: {mean_hof:.4f} +/- {std_hof:.4f}")
print(f"  QV=16 certified: {'YES' if n_pass >= 7 else 'NO'} (need >= 7/10 at 2-sigma)")

# Confidence interval: 1-sided test at 97.5% (2-sigma)
# From binomial: if true HOF = 2/3, P(HOF > 2/3) > 97.5%
# We use the mean +/- 2*stderr approach
stderr = std_hof / math.sqrt(10)
lower_bound = mean_hof - 2 * stderr
print(f"  2-sigma lower bound: {lower_bound:.4f} (need > 0.6667)")
print(f"  QV=16 certified (statistical): {'YES' if lower_bound > 2/3 else 'NO'}")

# ============================================================
# 2. VQE REM 004-008 — STATISTICAL ANALYSIS
# ============================================================

print("\n" + "=" * 70)
print("  VQE H2 PS+REM — Tuna-9 Hardware Results (runs 004-008)")
print("=" * 70)

# VQE coefficients
g0 = -0.321124
g1 = 0.397937
g2 = -0.397937
g3 = 0.0
g4 = 0.090466
g5 = 0.090466
fci_energy = -1.137306

# All hardware counts per run per basis
vqe_all_counts = {
    "004": {
        "z": {"job_id": 425234, "counts": {"00000": 218, "00001": 4, "00010": 3, "00100": 3634, "00101": 55, "00110": 46, "00111": 1, "01100": 16, "01110": 1, "10000": 67, "10001": 2, "10100": 48, "10101": 1}},
        "x": {"job_id": 425235, "counts": {"00000": 832, "00001": 10, "00010": 17, "00100": 1198, "00101": 13, "00110": 10, "01000": 7, "01100": 2, "10000": 1194, "10001": 22, "10010": 21, "10100": 738, "10101": 9, "10110": 14, "11000": 8, "11100": 1}},
        "y": {"job_id": 425236, "counts": {"00000": 775, "00001": 6, "00010": 23, "00100": 1106, "00101": 12, "00110": 31, "01000": 4, "01100": 4, "10000": 1193, "10001": 12, "10010": 32, "10100": 857, "10101": 10, "10110": 21, "11000": 6, "11100": 4}},
    },
    "005": {
        "z": {"job_id": 425267, "counts": {"00000": 56, "00001": 2, "00010": 1, "00100": 3808, "00101": 59, "00110": 60, "01100": 11, "10000": 58, "10001": 1, "10100": 35, "10101": 1, "10110": 3, "11000": 1}},
        "x": {"job_id": 425269, "counts": {"00000": 843, "00001": 11, "00010": 10, "00100": 1210, "00101": 14, "00110": 21, "01000": 8, "01100": 8, "01101": 1, "10000": 1146, "10001": 19, "10010": 19, "10100": 756, "10101": 6, "10110": 12, "11000": 8, "11100": 4}},
        "y": {"job_id": 425270, "counts": {"00000": 764, "00001": 9, "00010": 15, "00100": 1144, "00101": 15, "00110": 26, "00111": 1, "01000": 2, "01100": 2, "10000": 1188, "10001": 18, "10010": 33, "10100": 845, "10101": 12, "10110": 16, "11000": 4, "11100": 1, "11110": 1}},
    },
    "006": {
        "z": {"job_id": 425271, "counts": {"00000": 54, "00001": 3, "00010": 1, "00100": 3826, "00101": 53, "00110": 39, "01100": 16, "01101": 1, "01110": 1, "10000": 55, "10010": 3, "10100": 43, "10101": 1}},
        "x": {"job_id": 425272, "counts": {"00000": 843, "00001": 14, "00010": 11, "00100": 1226, "00101": 14, "00110": 15, "00111": 1, "01000": 4, "01001": 2, "01100": 12, "10000": 1196, "10001": 25, "10010": 16, "10100": 687, "10101": 8, "10110": 10, "11000": 10, "11100": 2}},
        "y": {"job_id": 425273, "counts": {"00000": 721, "00001": 22, "00010": 19, "00100": 1134, "00101": 15, "00110": 25, "01000": 4, "01100": 7, "10000": 1221, "10001": 23, "10010": 26, "10100": 832, "10101": 17, "10110": 19, "11000": 7, "11001": 1, "11100": 3}},
    },
    "007": {
        "z": {"job_id": 425274, "counts": {"00000": 68, "00001": 5, "00100": 3775, "00101": 40, "00110": 63, "01100": 16, "01101": 3, "10000": 67, "10001": 2, "10010": 4, "10100": 52, "10110": 1}},
        "x": {"job_id": 425275, "counts": {"00000": 846, "00001": 13, "00010": 10, "00100": 1204, "00101": 15, "00110": 18, "01000": 4, "01010": 1, "01100": 8, "10000": 1146, "10001": 20, "10010": 18, "10100": 763, "10101": 11, "10110": 7, "11000": 4, "11100": 8}},
        "y": {"job_id": 425276, "counts": {"00000": 720, "00001": 13, "00010": 17, "00011": 1, "00100": 1131, "00101": 13, "00110": 37, "00111": 1, "01000": 5, "01100": 4, "10000": 1164, "10001": 24, "10010": 32, "10100": 893, "10101": 18, "10110": 17, "11000": 4, "11001": 1, "11100": 1}},
    },
    "008": {
        "z": {"job_id": 425277, "counts": {"00000": 72, "00001": 2, "00010": 2, "00100": 3774, "00101": 60, "00110": 46, "00111": 4, "01100": 15, "10000": 66, "10100": 55}},
        "x": {"job_id": 425278, "counts": {"00000": 829, "00001": 11, "00010": 11, "00100": 1233, "00101": 24, "00110": 22, "00111": 1, "01000": 4, "01100": 8, "10000": 1193, "10001": 16, "10010": 18, "10011": 1, "10100": 691, "10101": 9, "10110": 11, "11000": 9, "11100": 5}},
        "y": {"job_id": 425279, "counts": {"00000": 704, "00001": 15, "00010": 24, "00011": 2, "00100": 1186, "00101": 13, "00110": 35, "01000": 3, "01100": 7, "10000": 1131, "10001": 20, "10010": 31, "10100": 892, "10101": 12, "10110": 14, "11000": 5, "11100": 2}},
    },
}

def extract_q2_q4(bitstring):
    """Extract q2 and q4 from 5-qubit MSB-first bitstring.
    MSB-first: str[0]=q4, str[1]=q3, str[2]=q2, str[3]=q1, str[4]=q0"""
    q4 = int(bitstring[0])
    q2 = int(bitstring[2])
    return q2, q4

def post_select(counts, n_qubits=5, active_qubits=[2, 4]):
    """Post-select: keep only shots where non-active qubits are 0."""
    filtered = {}
    total_raw = sum(counts.values())
    for bitstring, count in counts.items():
        valid = True
        for q in range(n_qubits):
            if q not in active_qubits:
                pos = n_qubits - 1 - q
                if int(bitstring[pos]) != 0:
                    valid = False
                    break
        if valid:
            q2, q4 = extract_q2_q4(bitstring)
            key = f"{q2}{q4}"
            filtered[key] = filtered.get(key, 0) + count
    total_ps = sum(filtered.values())
    return filtered, total_ps, total_raw

def compute_vqe_energy(z_counts, x_counts, y_counts):
    """Compute VQE energy from 3-basis post-selected counts."""
    z_ps, z_total, z_raw = post_select(z_counts)
    x_ps, x_total, x_raw = post_select(x_counts)
    y_ps, y_total, y_raw = post_select(y_counts)

    zi = sum((-1)**int(k[0]) * v for k, v in z_ps.items()) / z_total
    iz = sum((-1)**int(k[1]) * v for k, v in z_ps.items()) / z_total
    zz = sum((-1)**(int(k[0])+int(k[1])) * v for k, v in z_ps.items()) / z_total
    xx = sum((-1)**(int(k[0])+int(k[1])) * v for k, v in x_ps.items()) / x_total
    yy = sum((-1)**(int(k[0])+int(k[1])) * v for k, v in y_ps.items()) / y_total

    energy = g0 + g1*zi + g2*iz + g3*zz + g4*xx + g5*yy

    return {
        "zi": zi, "iz": iz, "zz": zz, "xx": xx, "yy": yy,
        "energy": energy,
        "z_acceptance": z_total / z_raw,
        "x_acceptance": x_total / x_raw,
        "y_acceptance": y_total / y_raw,
        "z_ps": z_ps, "x_ps": x_ps, "y_ps": y_ps,
    }

energies = []
for run_id in ["004", "005", "006", "007", "008"]:
    data = vqe_all_counts[run_id]
    result = compute_vqe_energy(data["z"]["counts"], data["x"]["counts"], data["y"]["counts"])
    error_mha = abs(result["energy"] - fci_energy) * 1000

    print(f"\n  Run {run_id}:")
    print(f"    <ZI>={result['zi']:.4f}  <IZ>={result['iz']:.4f}  <ZZ>={result['zz']:.4f}")
    print(f"    <XX>={result['xx']:.4f}  <YY>={result['yy']:.4f}")
    print(f"    Energy = {result['energy']:.6f} Ha")
    print(f"    Error  = {error_mha:.2f} mHa")
    print(f"    PS acceptance: Z={result['z_acceptance']:.1%}  X={result['x_acceptance']:.1%}  Y={result['y_acceptance']:.1%}")

    energies.append(result["energy"])

# REM: average over 5 runs
mean_energy = np.mean(energies)
std_energy = np.std(energies, ddof=1)
stderr_energy = std_energy / math.sqrt(5)
error_mha = abs(mean_energy - fci_energy) * 1000

print(f"\n  --- VQE PS+REM Summary (5 runs) ---")
print(f"  Individual energies: {['%.6f' % e for e in energies]}")
print(f"  Mean energy: {mean_energy:.6f} +/- {stderr_energy:.6f} Ha")
print(f"  FCI energy:  {fci_energy:.6f} Ha")
print(f"  Error:       {error_mha:.2f} mHa")
print(f"  Std dev:     {std_energy*1000:.2f} mHa")
print(f"  Chemical accuracy (<1.6 mHa): {'YES' if error_mha < 1.6 else 'NO'}")

# ============================================================
# 3. QAOA MAXCUT ON 4-CYCLE SUBGRAPHS
# ============================================================

print("\n" + "=" * 70)
print("  QAOA MaxCut on 4-cycle — Tuna-9 Hardware Results")
print("=" * 70)

# QAOA circuits:
# Cycle A p=1: q4-q6-q8-q7 (8 CNOTs)
# Cycle A p=2: q4-q6-q8-q7 (16 CNOTs)
# Cycle B p=1: q2-q4-q7-q5 (8 CNOTs)

qaoa_hw = {
    "cycle_a_p1": {"job_id": 425280, "physical_qubits": [4, 6, 7, 8], "cycle_edges": [(4,6),(6,8),(8,7),(7,4)], "cnots": 8,
        "counts": {"000000000": 930, "000000001": 14, "000000010": 1, "000000100": 11, "000000101": 1, "000001000": 5, "000010000": 91, "000010001": 3, "000010010": 1, "000011000": 1, "000100000": 12, "000110000": 4, "001000000": 143, "001000001": 4, "001010000": 248, "001010001": 6, "001010100": 1, "001100000": 2, "001110000": 4, "010000000": 152, "010000001": 1, "010000010": 2, "010000100": 2, "010010000": 233, "010010001": 5, "010010100": 2, "010011000": 1, "010100000": 1, "010110000": 2, "011000000": 45, "011000001": 2, "011010000": 245, "011010001": 6, "011010010": 1, "011010100": 2, "011110000": 1, "100000000": 194, "100000001": 2, "100010000": 49, "100100000": 8, "100100001": 1, "100110000": 1, "101000000": 322, "101000001": 7, "101000010": 1, "101000100": 4, "101010000": 268, "101010001": 5, "101010100": 3, "101011000": 2, "101100000": 4, "101110000": 8, "110000000": 317, "110000001": 9, "110000010": 1, "110000100": 2, "110010000": 121, "110010001": 2, "110010100": 2, "110100000": 3, "110110000": 2, "111000000": 148, "111000001": 3, "111000010": 1, "111001000": 1, "111010000": 403, "111010001": 7, "111010010": 3, "111010100": 2, "111100000": 1, "111110000": 3, "111110010": 1}},
    "cycle_a_p2": {"job_id": 425281, "physical_qubits": [4, 6, 7, 8], "cycle_edges": [(4,6),(6,8),(8,7),(7,4)], "cnots": 16,
        "counts": {"000000000": 1151, "000000001": 15, "000000010": 6, "000000011": 1, "000000100": 14, "000001000": 4, "000010000": 67, "000010001": 2, "000010100": 1, "000100000": 13, "000110000": 2, "000110100": 1, "001000000": 167, "001000001": 1, "001000100": 1, "001010000": 103, "001010001": 2, "001011000": 1, "001100000": 4, "010000000": 254, "010000001": 5, "010000010": 1, "010000100": 3, "010010000": 165, "010010001": 1, "010010100": 3, "010100000": 1, "010110000": 5, "011000000": 49, "011000001": 1, "011001000": 1, "011010000": 171, "011010001": 6, "011010010": 1, "011010100": 3, "011011000": 1, "011110000": 2, "011110010": 1, "100000000": 258, "100000001": 7, "100000010": 1, "100000100": 2, "100001000": 2, "100010000": 59, "100010001": 2, "100010100": 1, "100100000": 6, "100100100": 1, "100110000": 3, "101000000": 159, "101000001": 2, "101000010": 1, "101000100": 1, "101010000": 157, "101010001": 4, "101100000": 3, "101110000": 4, "101110001": 1, "110000000": 462, "110000001": 8, "110000010": 1, "110000100": 3, "110010000": 173, "110010001": 3, "110010100": 2, "110011000": 1, "110100000": 4, "110110000": 4, "111000000": 161, "111000001": 5, "111000010": 1, "111010000": 348, "111010001": 5, "111010100": 3, "111011000": 1, "111100000": 2, "111110000": 5}},
    "cycle_b_p1": {"job_id": 425282, "physical_qubits": [2, 4, 5, 7], "cycle_edges": [(2,4),(4,7),(7,5),(5,2)], "cnots": 8,
        "counts": {"000000000": 866, "000000001": 12, "000000010": 8, "000000011": 1, "000000100": 157, "000000101": 3, "000000110": 2, "000001000": 4, "000001100": 4, "000010000": 144, "000010001": 1, "000010100": 348, "000010101": 5, "000010110": 1, "000011100": 3, "000100000": 89, "000100001": 1, "000100010": 3, "000100100": 339, "000100101": 6, "000100110": 4, "000101000": 1, "000101100": 2, "000110000": 65, "000110100": 311, "000110101": 4, "000110110": 2, "000111100": 1, "001000000": 41, "001000100": 9, "001010000": 12, "001010100": 11, "001100000": 7, "001100100": 18, "001110000": 1, "001110100": 14, "010000000": 139, "010000001": 2, "010000010": 1, "010000100": 50, "010000101": 1, "010001000": 1, "010001100": 1, "010010000": 195, "010010001": 1, "010010010": 1, "010010100": 114, "010010101": 2, "010010110": 1, "010011000": 1, "010011100": 3, "010100000": 208, "010100001": 2, "010100010": 2, "010100100": 251, "010100101": 6, "010100110": 1, "010101000": 3, "010101100": 1, "010110000": 63, "010110001": 1, "010110010": 1, "010110100": 451, "010110101": 5, "010110110": 4, "010111000": 1, "011000000": 10, "011000100": 2, "011010000": 12, "011010100": 6, "011100000": 10, "011100100": 9, "011110000": 4, "011110100": 18, "100000000": 4, "100100000": 1, "100100100": 1, "100110000": 1, "100110100": 1, "100110110": 1, "110010000": 1, "110100000": 1, "110110100": 1}},
}

def extract_qaoa_qubits(bitstring, physical_qubits, n_total=9):
    """Extract physical qubit values from 9-bit MSB-first bitstring."""
    vals = {}
    for q in physical_qubits:
        pos = n_total - 1 - q  # MSB-first
        vals[q] = int(bitstring[pos])
    return vals

def maxcut_value(qubit_vals, edges):
    """Count number of edges cut by the assignment."""
    cuts = 0
    for (a, b) in edges:
        if qubit_vals[a] != qubit_vals[b]:
            cuts += 1
    return cuts

for circuit_name, data in qaoa_hw.items():
    counts = data["counts"]
    total = sum(counts.values())
    edges = data["cycle_edges"]
    phys = data["physical_qubits"]
    n_edges = len(edges)

    # Compute expected MaxCut value
    total_cuts = 0
    for bitstring, count in counts.items():
        vals = extract_qaoa_qubits(bitstring, phys)
        cuts = maxcut_value(vals, edges)
        total_cuts += cuts * count

    expected_cuts = total_cuts / total
    ratio = expected_cuts / n_edges  # max cut for 4-cycle = 4

    # Distribution of cut values
    cut_dist = {}
    for bitstring, count in counts.items():
        vals = extract_qaoa_qubits(bitstring, phys)
        cuts = maxcut_value(vals, edges)
        cut_dist[cuts] = cut_dist.get(cuts, 0) + count

    print(f"\n  {circuit_name} (job {data['job_id']}, {data['cnots']} CNOTs):")
    print(f"    Cycle: {' - '.join(f'q{q}' for q in phys)}")
    print(f"    Cut distribution: {dict(sorted(cut_dist.items()))}")
    print(f"    Expected cuts: {expected_cuts:.3f} / {n_edges}")
    print(f"    Approximation ratio: {ratio:.4f}")
    print(f"    Random baseline: 0.5000")
    print(f"    Ideal p=1: ~0.75")
    print(f"    Beats random: {'YES' if ratio > 0.5 else 'NO'}")

# ============================================================
# Save all results
# ============================================================

# QV=16 full results
qv_output = {
    "experiment": "qv16-tuna9-hardware",
    "description": "Quantum Volume 16 test on Tuna-9. 10 random SU(4) circuits, "
                   "4 qubits (q4,q6,q7,q8), 4 layers, 8 CNOTs each.",
    "backend": "tuna-9",
    "date": "2026-02-13",
    "physical_qubits": [4, 6, 7, 8],
    "n_circuits": 10,
    "n_layers": 4,
    "shots": 4096,
    "results": qv_results,
    "summary": {
        "n_pass": n_pass,
        "mean_hof": round(mean_hof, 4),
        "std_hof": round(std_hof, 4),
        "lower_bound_2sigma": round(lower_bound, 4),
        "qv16_certified": bool(lower_bound > 2/3),
    },
}
with open("/Users/dereklomas/haiqu/experiments/results/qv16-tuna9-hardware.json", "w") as f:
    json.dump(qv_output, f, indent=2)
print(f"\n  Saved QV=16 results to experiments/results/qv16-tuna9-hardware.json")

# VQE REM full results
vqe_output = {
    "experiment": "vqe-tuna9-rem-004-008",
    "description": "VQE H2 with Post-Selection + Randomized Expectation-value Measurement. "
                   "5 identical runs for REM statistics.",
    "backend": "tuna-9",
    "date": "2026-02-13",
    "parameters": {
        "shots_per_run": 4096,
        "n_runs": 5,
        "bond_distance": 0.735,
        "alpha": -0.2234,
        "qubits": [2, 4],
        "g0": g0, "g1": g1, "g2": g2, "g3": g3, "g4": g4, "g5": g5,
        "fci_energy": fci_energy,
    },
    "individual_energies": [round(e, 6) for e in energies],
    "mean_energy": round(mean_energy, 6),
    "std_energy": round(std_energy, 6),
    "stderr_energy": round(stderr_energy, 6),
    "error_mHa": round(error_mha, 2),
    "chemical_accuracy": bool(error_mha < 1.6),
}
with open("/Users/dereklomas/haiqu/experiments/results/vqe-tuna9-rem-004-008.json", "w") as f:
    json.dump(vqe_output, f, indent=2)
print(f"  Saved VQE REM results to experiments/results/vqe-tuna9-rem-004-008.json")

# QAOA results
qaoa_output = {
    "experiment": "qaoa-maxcut-4cycle-tuna9",
    "description": "QAOA MaxCut on 4-cycle subgraphs of Tuna-9 topology. "
                   "Cycle A: q4-q6-q8-q7, Cycle B: q2-q4-q7-q5.",
    "backend": "tuna-9",
    "date": "2026-02-13",
    "shots": 4096,
    "results": {},
}
for circuit_name, data in qaoa_hw.items():
    counts = data["counts"]
    total = sum(counts.values())
    edges = data["cycle_edges"]
    phys = data["physical_qubits"]
    total_cuts = 0
    for bitstring, count in counts.items():
        vals = extract_qaoa_qubits(bitstring, phys)
        cuts = maxcut_value(vals, edges)
        total_cuts += cuts * count
    expected_cuts = total_cuts / total
    ratio = expected_cuts / len(edges)

    qaoa_output["results"][circuit_name] = {
        "job_id": data["job_id"],
        "physical_qubits": phys,
        "cycle_edges": [list(e) for e in edges],
        "cnots": data["cnots"],
        "expected_cuts": round(expected_cuts, 4),
        "max_cuts": len(edges),
        "approximation_ratio": round(ratio, 4),
        "beats_random": bool(ratio > 0.5),
    }
with open("/Users/dereklomas/haiqu/experiments/results/qaoa-tuna9-hardware.json", "w") as f:
    json.dump(qaoa_output, f, indent=2)
print(f"  Saved QAOA results to experiments/results/qaoa-tuna9-hardware.json")
